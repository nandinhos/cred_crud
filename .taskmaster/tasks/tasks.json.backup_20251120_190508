{
  "master": {
    "tasks": [
      {
        "id": 1,
        "title": "Correção de Validação de Datas e Campos do Model Credential",
        "description": "Corrigir validação de datas (GAP001) e ajustar inconsistências entre store/update (GAP004) no CredentialController",
        "details": "1. Atualizar regras de validação em `app/Http/Controllers/CredentialController.php`:\n   - Alterar 'concession' e 'validity' de 'string' para 'date' ou 'date_format:Y-m-d'\n   - Adicionar validação 'after:today' em 'validity'\n   - Garantir mesmas regras em store() e update()\n2. Atualizar migration se necessário para garantir tipo DATE correto\n3. Verificar casts no Model Credential:\n   ```php\n   protected $casts = [\n       'concession' => 'date',\n       'validity' => 'date',\n   ];\n   ```\n4. Remover ou documentar uso do campo 'credential' (GAP002)\n5. Adicionar validação customizada para FSCS único considerando soft deletes:\n   ```php\n   'fscs' => ['required', 'string', Rule::unique('credentials')->whereNull('deleted_at')]\n   ```",
        "testStrategy": "1. Teste unitário com Pest para validação de datas inválidas\n2. Teste funcional tentando cadastrar credencial com data de validade no passado\n3. Teste de duplicação de FSCS em registros ativos\n4. Verificar que registros soft deleted não impedem novo cadastro com mesmo FSCS",
        "priority": "high",
        "dependencies": [],
        "status": "done",
        "subtasks": [
          {
            "id": 1,
            "title": "Atualizar regras de validação no CredentialController para campos de data",
            "description": "Modificar as regras de validação nos métodos store() e update() do CredentialController, alterando 'concession' e 'validity' de 'string' para 'date', adicionando validação 'after:today' em 'validity' e garantindo consistência entre ambos os métodos.",
            "dependencies": [],
            "details": "Editar app/Http/Controllers/CredentialController.php e atualizar os arrays de validação nos métodos store() e update(). Alterar as regras dos campos 'concession' e 'validity' de 'required|string' para 'required|date' ou 'required|date_format:Y-m-d'. Adicionar a regra 'after:today' ou 'after:now' no campo 'validity' para garantir que apenas datas futuras sejam aceitas. Verificar que ambos os métodos (store e update) possuem exatamente as mesmas regras de validação para evitar inconsistências (GAP004).",
            "status": "done",
            "testStrategy": "Criar testes Pest verificando: (1) rejeição de datas inválidas ou em formato incorreto, (2) rejeição de 'validity' com data passada, (3) aceitação de datas válidas e futuras, (4) consistência entre validações de store() e update().",
            "updatedAt": "2025-11-19T01:02:12.785Z",
            "parentId": "undefined"
          },
          {
            "id": 2,
            "title": "Modificar migrations para garantir tipos DATE corretos nos campos de data",
            "description": "Atualizar a migration da tabela credentials para garantir que os campos 'concession' e 'validity' utilizem o tipo DATE correto no banco de dados, criando nova migration se necessário.",
            "dependencies": [],
            "details": "Verificar a migration existente em database/migrations/*_create_credentials_table.php. Se os campos 'concession' e 'validity' estiverem definidos como $table->string(), criar uma nova migration usando php artisan make:migration update_credentials_table_date_fields para alterar esses campos para $table->date('concession') e $table->date('validity'). Utilizar Schema::table() com os métodos $table->date()->change() para modificar os tipos existentes. Executar php artisan migrate para aplicar as mudanças.",
            "status": "done",
            "testStrategy": "Verificar através de php artisan migrate:fresh que a migration executa sem erros. Inspecionar o schema do banco de dados para confirmar que os campos são do tipo DATE. Testar inserção manual de registros com datas válidas.",
            "parentId": "undefined",
            "updatedAt": "2025-11-19T01:02:28.854Z"
          },
          {
            "id": 3,
            "title": "Configurar casts no Model Credential para campos de data",
            "description": "Adicionar propriedade $casts no Model Credential para realizar conversão automática dos campos 'concession' e 'validity' para instâncias de Carbon/DateTime.",
            "dependencies": [
              2
            ],
            "details": "Editar app/Models/Credential.php e adicionar ou atualizar a propriedade protected $casts com os seguintes valores: 'concession' => 'date' e 'validity' => 'date'. Isso garantirá que o Eloquent converta automaticamente esses campos para objetos Carbon ao recuperar registros do banco de dados, facilitando manipulação e formatação de datas. Verificar se não há conflitos com outras propriedades do modelo como $dates (deprecated no Laravel moderno).",
            "status": "done",
            "testStrategy": "Criar teste Pest que recupera um registro de credencial do banco e verifica se $credential->concession e $credential->validity são instâncias de Illuminate\\Support\\Carbon. Testar também a formatação automática usando métodos como ->format('d/m/Y').",
            "parentId": "undefined",
            "updatedAt": "2025-11-19T01:02:41.251Z"
          },
          {
            "id": 4,
            "title": "Implementar validação de FSCS único considerando soft deletes",
            "description": "Adicionar regra de validação customizada para o campo 'fscs' garantindo unicidade apenas entre registros não deletados (soft deletes), utilizando Rule::unique com whereNull('deleted_at').",
            "dependencies": [
              1
            ],
            "details": "No CredentialController, nos métodos store() e update(), modificar a regra de validação do campo 'fscs' para utilizar Rule::unique('credentials')->whereNull('deleted_at'). No método update(), adicionar também ->ignore($credential->id) para permitir que o mesmo registro mantenha seu FSCS atual. Importar Illuminate\\Validation\\Rule no topo do arquivo. A validação completa ficará: 'fscs' => ['required', 'string', Rule::unique('credentials')->whereNull('deleted_at')] para store() e 'fscs' => ['required', 'string', Rule::unique('credentials')->whereNull('deleted_at')->ignore($credential->id)] para update().",
            "status": "done",
            "testStrategy": "Criar testes Pest para: (1) criação de credencial com FSCS único (sucesso), (2) tentativa de duplicar FSCS em registro ativo (falha), (3) criação de credencial com FSCS de registro soft deleted (sucesso), (4) atualização de credencial mantendo mesmo FSCS (sucesso), (5) atualização tentando usar FSCS de outro registro ativo (falha).",
            "parentId": "undefined",
            "updatedAt": "2025-11-19T01:02:49.966Z"
          },
          {
            "id": 5,
            "title": "Criar testes Pest para validações de data e duplicação de FSCS",
            "description": "Implementar suite completa de testes automatizados com Pest cobrindo todas as validações de campos de data (concession, validity) e regras de unicidade de FSCS considerando soft deletes.",
            "dependencies": [
              1,
              2,
              3,
              4
            ],
            "details": "Criar arquivo tests/Feature/Credentials/CredentialValidationTest.php com testes Pest organizados em grupos: (1) Validação de datas: testar rejeição de formato inválido, rejeição de 'validity' no passado, aceitação de datas válidas; (2) Validação de FSCS único: testar criação com FSCS duplicado (deve falhar), criação com FSCS de registro soft deleted (deve passar), atualização com FSCS de outro registro (deve falhar); (3) Consistência store/update: verificar que mesmas validações aplicam em ambos métodos. Utilizar factories para criar dados de teste e Database Transactions para rollback após cada teste. Adicionar assertions verificando mensagens de erro corretas.",
            "status": "done",
            "testStrategy": "Executar php artisan test --filter=CredentialValidationTest para verificar todos os testes passam. Verificar cobertura de código com php artisan test --coverage-html=coverage. Objetivo: 100% de cobertura nas regras de validação implementadas nos métodos store() e update() do CredentialController.",
            "parentId": "undefined",
            "updatedAt": "2025-11-19T01:03:23.952Z"
          }
        ],
        "complexity": 4,
        "recommendedSubtasks": 5,
        "expansionPrompt": "Divida esta tarefa em subtarefas específicas: (1) Atualizar regras de validação no CredentialController para campos de data, (2) Modificar migrations para garantir tipos DATE corretos, (3) Configurar casts no Model Credential, (4) Implementar validação de FSCS único considerando soft deletes, (5) Criar testes Pest para validações de data e duplicação",
        "updatedAt": "2025-11-19T01:03:23.952Z"
      },
      {
        "id": 2,
        "title": "Implementação de Sistema de Perfis e Autorização (RBAC)",
        "description": "Criar sistema de roles e permissions para controle de acesso granular (IMP001)",
        "details": "1. Criar migration para tabela 'roles':\n   - id, name (admin/consulta), description, timestamps\n2. Criar migration para tabela pivot 'role_user':\n   - user_id, role_id, timestamps\n3. Criar Model Role com relacionamento:\n   ```php\n   public function users() {\n       return $this->belongsToMany(User::class);\n   }\n   ```\n4. Atualizar Model User:\n   ```php\n   public function roles() {\n       return $this->belongsToMany(Role::class);\n   }\n   public function hasRole($role) {\n       return $this->roles->contains('name', $role);\n   }\n   ```\n5. Criar middleware 'CheckRole':\n   ```php\n   if (!$request->user()->hasRole($role)) {\n       abort(403);\n   }\n   ```\n6. Aplicar middleware nas rotas de credentials\n7. Criar Seeder com roles padrão (admin, consulta)",
        "testStrategy": "1. Teste Pest verificando que usuário 'consulta' não acessa rotas de edição/exclusão\n2. Teste que admin tem acesso total\n3. Teste de redirecionamento 403 para usuários não autorizados\n4. Verificar seeders criando roles corretamente",
        "priority": "high",
        "dependencies": [],
        "status": "done",
        "subtasks": [
          {
            "id": 1,
            "title": "Criar migration para tabela roles",
            "description": "Criar arquivo de migration para a tabela 'roles' com campos id, name, description e timestamps",
            "dependencies": [],
            "details": "Executar comando 'php artisan make:migration create_roles_table' e implementar estrutura com: id (primary key), name (string, unique - valores: admin/consulta), description (text nullable), timestamps. Adicionar índice no campo name para otimizar consultas de verificação de roles.",
            "status": "done",
            "testStrategy": "Executar migration e verificar estrutura da tabela no banco de dados usando 'php artisan migrate' e validar campos criados",
            "updatedAt": "2025-11-20T03:24:18.040Z",
            "parentId": "undefined"
          },
          {
            "id": 2,
            "title": "Criar migration para tabela pivot role_user",
            "description": "Criar migration para tabela pivot 'role_user' que relaciona usuários e roles em relacionamento many-to-many",
            "dependencies": [
              1
            ],
            "details": "Executar 'php artisan make:migration create_role_user_table' e implementar com: user_id (foreignId com constraint para users), role_id (foreignId com constraint para roles), timestamps. Adicionar índices compostos (user_id, role_id) e constraint de unicidade para evitar duplicação de atribuições.",
            "status": "done",
            "testStrategy": "Verificar criação da tabela pivot, constraints de foreign keys e índices. Testar inserção manual de relacionamento entre user e role",
            "parentId": "undefined",
            "updatedAt": "2025-11-20T03:24:35.068Z"
          },
          {
            "id": 3,
            "title": "Criar Model Role com relacionamentos",
            "description": "Criar Model Role com relacionamento belongsToMany para User e configurações necessárias",
            "dependencies": [
              1,
              2
            ],
            "details": "Executar 'php artisan make:model Role' e implementar: método users() retornando $this->belongsToMany(User::class) com tabela pivot role_user. Adicionar fillable com ['name', 'description'], casts apropriados e validação de valores permitidos para name (admin, consulta).",
            "status": "done",
            "testStrategy": "Teste Pest verificando criação de Role, atribuição a usuário via relacionamento e recuperação de users associados a um role. Validar eager loading funciona corretamente",
            "parentId": "undefined",
            "updatedAt": "2025-11-20T03:24:55.736Z"
          },
          {
            "id": 4,
            "title": "Atualizar Model User com métodos de verificação de roles",
            "description": "Adicionar relacionamento roles e métodos hasRole() e assignRole() no Model User existente",
            "dependencies": [
              2,
              3
            ],
            "details": "Atualizar app/Models/User.php adicionando: método roles() retornando $this->belongsToMany(Role::class), método hasRole($role) verificando se $this->roles->contains('name', $role), método assignRole($role) para atribuir role ao usuário, e método removeRole($role) para remover atribuição.",
            "status": "done",
            "testStrategy": "Teste Pest verificando: hasRole retorna true/false corretamente, assignRole atribui role ao usuário, removeRole remove corretamente, e eager loading de roles funciona sem N+1 queries",
            "parentId": "undefined",
            "updatedAt": "2025-11-20T03:25:13.333Z"
          },
          {
            "id": 5,
            "title": "Implementar middleware CheckRole",
            "description": "Criar middleware CheckRole para verificar se usuário autenticado possui role necessária para acessar rota",
            "dependencies": [
              4
            ],
            "details": "Executar 'php artisan make:middleware CheckRole' e implementar handle($request, Closure $next, $role) verificando: se usuário está autenticado, se possui role através de hasRole($role), retornar abort(403, 'Acesso negado') se não tiver permissão, ou $next($request) se autorizado. Registrar middleware em bootstrap/app.php ou Kernel.php com alias 'role'.",
            "status": "done",
            "testStrategy": "Teste funcional verificando: usuário com role 'admin' acessa rota protegida, usuário com role 'consulta' recebe 403 em rotas admin-only, usuário não autenticado é redirecionado para login",
            "parentId": "undefined",
            "updatedAt": "2025-11-20T03:25:40.915Z"
          },
          {
            "id": 6,
            "title": "Aplicar middleware nas rotas protegidas",
            "description": "Aplicar middleware CheckRole nas rotas de credentials e outras rotas que requerem controle de acesso baseado em roles",
            "dependencies": [
              5
            ],
            "details": "Atualizar routes/web.php aplicando middleware nas rotas: credentials.create, credentials.store, credentials.edit, credentials.update, credentials.destroy devem ter ->middleware('role:admin'). Rotas credentials.index e credentials.show podem ter ->middleware('role:consulta'). Agrupar rotas com mesma proteção usando Route::middleware().",
            "status": "done",
            "testStrategy": "Teste funcional com Feature tests verificando: usuário 'consulta' acessa index/show mas recebe 403 em create/edit/destroy, usuário 'admin' tem acesso total a todas rotas, respostas HTTP corretas (200, 403)",
            "parentId": "undefined",
            "updatedAt": "2025-11-20T03:26:17.505Z"
          },
          {
            "id": 7,
            "title": "Criar seeders com roles padrão e testes de autorização",
            "description": "Criar DatabaseSeeder para popular tabela roles com valores padrão (admin, consulta) e usuários de teste",
            "dependencies": [
              3
            ],
            "details": "Executar 'php artisan make:seeder RoleSeeder' criando roles: ['name' => 'admin', 'description' => 'Administrador com acesso total'] e ['name' => 'consulta', 'description' => 'Usuário com acesso somente leitura']. Criar UserSeeder atribuindo role admin ao primeiro usuário. Registrar seeders em DatabaseSeeder.php e documentar comando de execução.",
            "status": "done",
            "testStrategy": "Executar 'php artisan db:seed' e verificar: 2 roles criados (admin, consulta), pelo menos 1 usuário com role admin atribuído, testar login e acesso às rotas protegidas com usuários de diferentes roles",
            "parentId": "undefined",
            "updatedAt": "2025-11-20T03:28:09.289Z"
          }
        ],
        "complexity": 6,
        "recommendedSubtasks": 7,
        "expansionPrompt": "Divida esta tarefa em subtarefas: (1) Criar migration para tabela roles, (2) Criar migration para tabela pivot role_user, (3) Criar Model Role com relacionamentos, (4) Atualizar Model User com métodos de verificação de roles, (5) Implementar middleware CheckRole, (6) Aplicar middleware nas rotas protegidas, (7) Criar seeders com roles padrão e testes de autorização",
        "updatedAt": "2025-11-20T03:28:09.289Z"
      },
      {
        "id": 3,
        "title": "Sistema de Auditoria Completo com Activity Log",
        "description": "Implementar log detalhado de todas operações CRUD em credenciais (RF007, IMP002)",
        "details": "1. Criar migration para tabela 'activity_logs':\n   - id, user_id, credential_id (nullable), action (enum: created/updated/deleted/restored), old_values (json), new_values (json), ip_address, user_agent, timestamps\n2. Criar Model ActivityLog com relacionamentos:\n   ```php\n   public function user() { return $this->belongsTo(User::class); }\n   public function credential() { return $this->belongsTo(Credential::class); }\n   ```\n3. Criar Service class 'AuditService':\n   ```php\n   public static function log($action, $credential, $oldValues = null) {\n       ActivityLog::create([\n           'user_id' => auth()->id(),\n           'credential_id' => $credential?->id,\n           'action' => $action,\n           'old_values' => $oldValues,\n           'new_values' => $credential?->toArray(),\n           'ip_address' => request()->ip(),\n           'user_agent' => request()->userAgent()\n       ]);\n   }\n   ```\n4. Integrar em CredentialController:\n   - store(): AuditService::log('created', $credential)\n   - update(): AuditService::log('updated', $credential, $credential->getOriginal())\n   - destroy(): AuditService::log('deleted', $credential)\n5. Adicionar relacionamento em Credential Model",
        "testStrategy": "1. Teste verificando criação de log após cada operação CRUD\n2. Teste que old_values captura estado anterior corretamente\n3. Teste de integridade: log não pode ser deletado\n4. Verificar que IP e User Agent são capturados corretamente",
        "priority": "high",
        "dependencies": [
          "2"
        ],
        "status": "in-progress",
        "subtasks": [],
        "complexity": 7,
        "recommendedSubtasks": 6,
        "expansionPrompt": "Divida em subtarefas: (1) Criar migration para tabela activity_logs com campos JSON, (2) Criar Model ActivityLog com relacionamentos, (3) Implementar AuditService com métodos estáticos de logging, (4) Integrar AuditService em todos os métodos CRUD do CredentialController, (5) Adicionar captura de old_values antes de updates, (6) Criar testes verificando integridade e captura correta de dados de auditoria",
        "updatedAt": "2025-11-20T06:14:15.892Z"
      },
      {
        "id": 4,
        "title": "Relacionamento User-Credential e Controle de Propriedade",
        "description": "Adicionar relacionamento entre usuários e credenciais criadas (GAP003)",
        "details": "1. Criar migration adicionando 'created_by' e 'updated_by' em credentials:\n   ```php\n   $table->foreignId('created_by')->nullable()->constrained('users');\n   $table->foreignId('updated_by')->nullable()->constrained('users');\n   ```\n2. Atualizar Model Credential:\n   ```php\n   public function creator() {\n       return $this->belongsTo(User::class, 'created_by');\n   }\n   public function updater() {\n       return $this->belongsTo(User::class, 'updated_by');\n   }\n   ```\n3. Atualizar CredentialController:\n   - store(): $credential->created_by = auth()->id();\n   - update(): $credential->updated_by = auth()->id();\n4. Adicionar colunas na view de listagem:\n   - Criado por: {{ $credential->creator->name }}\n   - Atualizado por: {{ $credential->updater->name ?? '-' }}\n5. Eager loading para evitar N+1:\n   ```php\n   Credential::with(['creator', 'updater'])->get();\n   ```",
        "testStrategy": "1. Teste verificando que created_by é preenchido automaticamente\n2. Teste que updated_by muda após edição\n3. Teste de eager loading verificando quantidade de queries\n4. Verificar exibição correta dos nomes na interface",
        "priority": "medium",
        "dependencies": [
          "1"
        ],
        "status": "pending",
        "subtasks": [],
        "complexity": 5,
        "recommendedSubtasks": 5,
        "expansionPrompt": "Divida em subtarefas: (1) Criar migration adicionando campos created_by e updated_by, (2) Atualizar Model Credential com relacionamentos creator e updater, (3) Modificar CredentialController para preencher automaticamente created_by e updated_by, (4) Implementar eager loading nas queries para evitar N+1, (5) Atualizar views para exibir nomes de criador/atualizador e criar testes de relacionamento"
      },
      {
        "id": 5,
        "title": "Dashboard com Métricas e Indicadores de Credenciais",
        "description": "Criar dashboard com estatísticas, credenciais vencendo e KPIs (IMP005)",
        "details": "1. Criar DashboardController:\n   ```php\n   public function index() {\n       return view('dashboard', [\n           'totalActive' => Credential::count(),\n           'expiringIn30Days' => Credential::whereBetween('validity', [now(), now()->addDays(30)])->count(),\n           'expiringIn7Days' => Credential::whereBetween('validity', [now(), now()->addDays(7)])->count(),\n           'expired' => Credential::where('validity', '<', now())->count(),\n           'bySecrecy' => Credential::selectRaw('secrecy, count(*) as total')->groupBy('secrecy')->get(),\n           'recentActivity' => ActivityLog::with('user')->latest()->take(10)->get()\n       ]);\n   }\n   ```\n2. Criar view dashboard.blade.php com TailwindCSS:\n   - Cards com totais (total, vencidas, vencendo 30d, vencendo 7d)\n   - Gráfico de pizza com distribuição por grau de sigilo (usar AlpineJS + Chart.js)\n   - Lista de atividades recentes\n   - Alertas visuais para credenciais vencidas (vermelho) e vencendo (amarelo)\n3. Configurar rota GET /dashboard\n4. Adicionar link no menu de navegação",
        "testStrategy": "1. Teste unitário verificando cálculos de métricas\n2. Teste funcional acessando dashboard e verificando cards\n3. Teste de performance com dataset grande (>1000 registros)\n4. Verificar responsividade em mobile",
        "priority": "medium",
        "dependencies": [
          "3"
        ],
        "status": "pending",
        "subtasks": [],
        "complexity": 6,
        "recommendedSubtasks": 6,
        "expansionPrompt": "Divida em subtarefas: (1) Criar DashboardController com queries agregadas para métricas, (2) Implementar lógica de cálculo de credenciais vencidas e vencendo, (3) Criar view dashboard.blade.php com layout responsivo TailwindCSS, (4) Integrar Chart.js com AlpineJS para gráfico de distribuição por sigilo, (5) Adicionar componente de atividades recentes do ActivityLog, (6) Otimizar queries e criar testes de performance"
      },
      {
        "id": 6,
        "title": "Sistema de Filtros Avançados e Busca na Listagem",
        "description": "Implementar filtros por nome, FSCS, grau de sigilo e status de validade (RF004, IMP006)",
        "details": "1. Atualizar CredentialController@index com query builders:\n   ```php\n   $query = Credential::query();\n   \n   if ($search = request('search')) {\n       $query->where(function($q) use ($search) {\n           $q->where('name', 'like', \"%{$search}%\")\n             ->orWhere('fscs', 'like', \"%{$search}%\");\n       });\n   }\n   \n   if ($secrecy = request('secrecy')) {\n       $query->where('secrecy', $secrecy);\n   }\n   \n   if ($status = request('status')) {\n       if ($status === 'expired') {\n           $query->where('validity', '<', now());\n       } elseif ($status === 'expiring_30') {\n           $query->whereBetween('validity', [now(), now()->addDays(30)]);\n       } elseif ($status === 'valid') {\n           $query->where('validity', '>=', now()->addDays(30));\n       }\n   }\n   \n   $credentials = $query->with(['creator', 'updater'])->paginate(10)->withQueryString();\n   ```\n2. Criar componente Livewire CredentialFilters:\n   - Input de busca com debounce\n   - Select de grau de sigilo (Reservado/Secreto/Todos)\n   - Select de status (Válida/Vencendo 30d/Vencida/Todos)\n   - Botão limpar filtros\n3. Integrar Alpine.js para interatividade em tempo real\n4. Adicionar ordenação por colunas (nome, fscs, validade)",
        "testStrategy": "1. Teste verificando filtro por nome parcial\n2. Teste combinando múltiplos filtros simultaneamente\n3. Teste de paginação mantendo filtros aplicados\n4. Teste de performance com 10.000 registros\n5. Verificar debounce funcionando corretamente",
        "priority": "medium",
        "dependencies": [
          "1",
          "4"
        ],
        "status": "pending",
        "subtasks": [],
        "complexity": 7,
        "recommendedSubtasks": 7,
        "expansionPrompt": "Divida em subtarefas: (1) Implementar query builders dinâmicos no CredentialController com filtros compostos, (2) Criar componente Livewire CredentialFilters com inputs de busca, (3) Implementar debounce em busca de texto, (4) Adicionar filtros de select para grau de sigilo e status de validade, (5) Implementar ordenação por colunas clicáveis, (6) Garantir persistência de filtros na paginação com withQueryString, (7) Otimizar queries e criar testes de performance com 10k registros"
      },
      {
        "id": 7,
        "title": "Sistema de Notificações de Vencimento de Credenciais",
        "description": "Implementar alertas automáticos para credenciais próximas do vencimento (RF009, IMP008)",
        "details": "1. Criar migration para tabela 'notifications':\n   - id, user_id, credential_id, type (expiring_30/expiring_7/expired), read_at, sent_at, timestamps\n2. Criar Command 'CheckExpiringCredentials':\n   ```php\n   public function handle() {\n       $expiring30 = Credential::whereBetween('validity', [now(), now()->addDays(30)])->get();\n       $expiring7 = Credential::whereBetween('validity', [now(), now()->addDays(7)])->get();\n       \n       foreach ($expiring30 as $cred) {\n           Notification::firstOrCreate([\n               'credential_id' => $cred->id,\n               'type' => 'expiring_30'\n           ], ['user_id' => $cred->created_by]);\n       }\n       // Similar para expiring_7\n   }\n   ```\n3. Agendar comando no Kernel.php:\n   ```php\n   $schedule->command('credentials:check-expiring')->daily();\n   ```\n4. Criar componente Livewire NotificationBell:\n   - Badge com contador de não lidas\n   - Dropdown com lista de notificações\n   - Marcar como lida ao clicar\n5. Adicionar indicador visual na listagem (ícone de alerta)",
        "testStrategy": "1. Teste artisan command criando notificações corretas\n2. Teste que notificações duplicadas não são criadas\n3. Teste de contagem de não lidas\n4. Teste marcando notificação como lida\n5. Verificar agendamento do comando",
        "priority": "medium",
        "dependencies": [
          "5"
        ],
        "status": "pending",
        "subtasks": [],
        "complexity": 8,
        "recommendedSubtasks": 7,
        "expansionPrompt": "Divida em subtarefas: (1) Criar migration para tabela notifications, (2) Criar Model Notification com relacionamentos, (3) Implementar Command CheckExpiringCredentials com lógica de detecção, (4) Adicionar lógica de prevenção de duplicatas em notificações, (5) Configurar agendamento no Kernel.php, (6) Criar componente Livewire NotificationBell com contador e dropdown, (7) Implementar funcionalidade de marcar como lida e testes do comando"
      },
      {
        "id": 8,
        "title": "Sistema de Relatórios com Exportação PDF/Excel",
        "description": "Gerar relatórios filtrados por período, sigilo e status com exportação (RF008, IMP007)",
        "details": "1. Instalar dependências:\n   ```bash\n   composer require barryvdh/laravel-dompdf\n   composer require maatwebsite/excel\n   ```\n2. Criar ReportController:\n   ```php\n   public function credentials(Request $request) {\n       $query = Credential::query();\n       \n       if ($request->date_from) {\n           $query->where('concession', '>=', $request->date_from);\n       }\n       if ($request->date_to) {\n           $query->where('concession', '<=', $request->date_to);\n       }\n       if ($request->secrecy) {\n           $query->where('secrecy', $request->secrecy);\n       }\n       \n       $credentials = $query->with(['creator'])->get();\n       \n       if ($request->format === 'pdf') {\n           $pdf = PDF::loadView('reports.credentials-pdf', compact('credentials'));\n           return $pdf->download('relatorio-credenciais.pdf');\n       }\n       \n       return Excel::download(new CredentialsExport($credentials), 'credenciais.xlsx');\n   }\n   ```\n3. Criar views:\n   - reports/form.blade.php (filtros de relatório)\n   - reports/credentials-pdf.blade.php (template PDF)\n4. Criar CredentialsExport class implementando FromCollection\n5. Adicionar rotas e menu de relatórios",
        "testStrategy": "1. Teste gerando PDF com dataset de 100 registros\n2. Teste exportação Excel verificando estrutura de colunas\n3. Teste filtros de período funcionando corretamente\n4. Verificar formatação de datas no relatório\n5. Teste de performance com 5000 registros",
        "priority": "medium",
        "dependencies": [
          "6"
        ],
        "status": "pending",
        "subtasks": [],
        "complexity": 7,
        "recommendedSubtasks": 8,
        "expansionPrompt": "Divida em subtarefas: (1) Instalar e configurar dependências barryvdh/laravel-dompdf e maatwebsite/excel, (2) Criar ReportController com query builders para filtros de relatório, (3) Implementar lógica de filtragem por período, sigilo e status, (4) Criar view reports/form.blade.php com formulário de filtros, (5) Criar template PDF reports/credentials-pdf.blade.php com formatação, (6) Implementar CredentialsExport class para Excel, (7) Otimizar queries para grandes volumes, (8) Criar testes de exportação e performance com 5k registros"
      },
      {
        "id": 9,
        "title": "Correção do SweetAlert e Feedback Visual",
        "description": "Implementar SweetAlert2 corretamente para confirmações e notificações (GAP005, RNF005)",
        "details": "1. Instalar via NPM:\n   ```bash\n   npm install sweetalert2\n   ```\n2. Importar em resources/js/app.js:\n   ```javascript\n   import Swal from 'sweetalert2';\n   window.Swal = Swal;\n   ```\n3. Criar helper Blade em AppServiceProvider:\n   ```php\n   Blade::directive('swal', function ($expression) {\n       return \"<?php session()->flash('swal', {$expression}); ?>\";\n   });\n   ```\n4. Adicionar script no layout principal:\n   ```javascript\n   @if(session('swal'))\n       Swal.fire(@json(session('swal')));\n   @endif\n   ```\n5. Atualizar CredentialController:\n   - store(): return redirect()->with('swal', ['icon' => 'success', 'title' => 'Credencial cadastrada!'])\n   - update(): similar\n   - destroy(): confirmação antes de deletar\n6. Adicionar confirmação de exclusão:\n   ```javascript\n   function confirmDelete(id) {\n       Swal.fire({\n           title: 'Tem certeza?',\n           text: 'Esta ação não pode ser revertida',\n           icon: 'warning',\n           showCancelButton: true\n       }).then((result) => {\n           if (result.isConfirmed) {\n               document.getElementById('delete-form-' + id).submit();\n           }\n       });\n   }\n   ```",
        "testStrategy": "1. Teste funcional verificando alert de sucesso após criar credencial\n2. Teste de confirmação antes de deletar\n3. Teste de cancelamento da exclusão\n4. Verificar estilos e tema do SweetAlert2\n5. Teste em diferentes navegadores",
        "priority": "medium",
        "dependencies": [
          "1"
        ],
        "status": "pending",
        "subtasks": [],
        "complexity": 4,
        "recommendedSubtasks": 5,
        "expansionPrompt": "Divida em subtarefas: (1) Instalar SweetAlert2 via NPM e configurar build assets, (2) Importar e expor SweetAlert2 globalmente em app.js, (3) Criar Blade directive customizado para mensagens flash, (4) Adicionar script de renderização no layout principal, (5) Integrar confirmações e notificações em CredentialController e criar testes funcionais de feedback visual"
      },
      {
        "id": 10,
        "title": "Suite Completa de Testes Automatizados com Pest",
        "description": "Criar cobertura de testes para todas funcionalidades críticas (IMP009)",
        "details": "1. Configurar Pest já existente e instalar plugins:\n   ```bash\n   composer require pestphp/pest-plugin-laravel --dev\n   ```\n2. Criar testes de Feature:\n   - tests/Feature/Auth/LoginTest.php (login, logout, sessão)\n   - tests/Feature/Credentials/CreateCredentialTest.php (validações, criação)\n   - tests/Feature/Credentials/UpdateCredentialTest.php (edição, validações)\n   - tests/Feature/Credentials/DeleteCredentialTest.php (soft delete, auditoria)\n   - tests/Feature/Credentials/FilterCredentialTest.php (busca, filtros)\n   - tests/Feature/Authorization/RoleTest.php (permissões por perfil)\n   - tests/Feature/Reports/ExportTest.php (PDF, Excel)\n3. Criar testes de Unit:\n   - tests/Unit/Models/CredentialTest.php (relationships, scopes)\n   - tests/Unit/Services/AuditServiceTest.php (logging)\n4. Usar factories e seeders:\n   ```php\n   it('creates credential with valid data', function () {\n       $user = User::factory()->create();\n       actingAs($user)\n           ->post('/credentials', [\n               'fscs' => '123456',\n               'name' => 'João Silva',\n               'secrecy' => 'R',\n               'validity' => now()->addYear()->format('Y-m-d')\n           ])\n           ->assertRedirect()\n           ->assertSessionHas('swal');\n       \n       expect(Credential::where('fscs', '123456')->exists())->toBeTrue();\n   });\n   ```\n5. Configurar CI para rodar testes automaticamente\n6. Meta: >80% de cobertura de código",
        "testStrategy": "1. Executar php artisan test --coverage\n2. Verificar cobertura mínima de 80%\n3. Teste de integração completo (criar usuário -> login -> CRUD completo)\n4. Teste de regressão após cada mudança\n5. Performance test com database seeder de 1000 registros",
        "priority": "high",
        "dependencies": [
          "1",
          "2",
          "3",
          "4",
          "6",
          "7",
          "8",
          "9"
        ],
        "status": "pending",
        "subtasks": [],
        "complexity": 9,
        "recommendedSubtasks": 10,
        "expansionPrompt": "Divida em subtarefas: (1) Configurar Pest plugins e factories, (2) Criar testes de autenticação (login, logout, sessões), (3) Criar testes CRUD de credenciais com validações, (4) Implementar testes de autorização RBAC, (5) Criar testes de auditoria e activity logs, (6) Implementar testes de filtros e busca, (7) Criar testes de notificações e scheduled tasks, (8) Implementar testes de exportação PDF/Excel, (9) Criar testes de integração completos, (10) Configurar análise de cobertura e CI pipeline"
      },
      {
        "id": 11,
        "title": "Refatoração Completa do Sistema para Laravel 12 com Filament 4",
        "description": "Migração completa da aplicação atual para Laravel 12 e implementação do Filament 4 como painel administrativo, substituindo controllers/views Blade por recursos Filament modernos.",
        "details": "1. **Atualização de Dependências Base**:\n   ```bash\n   composer require laravel/framework:^12.0\n   composer require filament/filament:^4.0\n   composer require spatie/laravel-permission:^6.0\n   ```\n\n2. **Configuração Inicial do Filament 4**:\n   ```bash\n   php artisan filament:install --panels\n   php artisan make:filament-user\n   ```\n   - Configurar AdminPanelProvider em app/Providers/Filament/\n   - Adicionar plugins: Shield (permissions), Spatie Media Library\n\n3. **Migração de Models para Laravel 12**:\n   - Atualizar sintaxe de casts para formato array:\n     ```php\n     protected function casts(): array {\n         return [\n             'concession' => 'date',\n             'validity' => 'date',\n             'created_at' => 'datetime',\n         ];\n     }\n     ```\n   - Implementar SoftDeletes com observers para auditoria\n   - Adicionar scopes para filtros de validade\n\n4. **Criação de Resources Filament**:\n   ```bash\n   php artisan make:filament-resource Credential --generate --soft-deletes\n   ```\n   - CredentialResource com campos:\n     * TextInput para name, fscs\n     * Select para secrecy (options: ['OSTENSIVO', 'RESERVADO', 'CONFIDENCIAL', 'SECRETO'])\n     * DatePicker para concession/validity com validação validity > today\n     * Toggle para is_active\n   - Implementar Table com filters (secrecy, status, date range)\n   - Bulk actions para exportação PDF/Excel\n   - Custom page para visualização com tabs (dados, histórico, anexos)\n\n5. **Sistema de Autenticação e Permissões**:\n   - Integrar Spatie Permission com Filament Shield:\n     ```bash\n     composer require bezhansalleh/filament-shield\n     php artisan shield:install\n     ```\n   - Criar roles: super_admin, admin, consulta\n   - Policies para Credential (view, create, update, delete, restore)\n   - Configurar navigation groups e badges\n\n6. **Widgets e Dashboard**:\n   - StatsOverviewWidget: total credenciais, expirando (30d), expiradas\n   - ChartWidget: credenciais por grau de sigilo (pie chart)\n   - TableWidget: últimas 10 credenciais criadas\n   - NotificationWidget: alertas de vencimento\n\n7. **Relatórios e Exportação**:\n   - Implementar ExportAction no CredentialResource:\n     ```php\n     ->headerActions([\n         ExportAction::make()\n             ->exporter(CredentialExporter::class)\n             ->formats([ExportFormat::Xlsx, ExportFormat::Pdf])\n     ])\n     ```\n   - Criar CredentialExporter com colunas customizadas\n   - Implementar filtros de data no export\n\n8. **Notificações com Filament**:\n   - DatabaseNotification para vencimentos:\n     ```php\n     Notification::make()\n         ->warning()\n         ->title('Credencial expirando em 7 dias')\n         ->body(\"{$credential->name} vence em {$credential->validity}\")\n         ->sendToDatabase($users);\n     ```\n   - Command agendado no Kernel para verificar vencimentos\n   - Badge no menu com contagem de não lidas\n\n9. **Temas e Customização**:\n   - Configurar cores do painel no AdminPanelProvider\n   - Custom theme com Tailwind (npm run build)\n   - Logo e favicon personalizados\n   - Traduções pt-BR: composer require filament/spatie-laravel-translatable-plugin\n\n10. **Migração de Rotas e Controllers**:\n    - Remover rotas web.php relacionadas ao CRUD (Filament gerencia)\n    - Manter apenas rotas públicas se necessário\n    - Depreciar CredentialController antigo após migração completa\n\n11. **Testes de Compatibilidade**:\n    - Atualizar phpunit.xml para Laravel 12\n    - Migrar factories para sintaxe nova\n    - Pest tests para Filament Resources usando actingAs($user)\n\n12. **Otimizações Laravel 12**:\n    - Implementar eager loading nos relationships\n    - Configurar cache de rotas/config/views\n    - Ativar horizon para queues se necessário\n    - Database optimization com indexes",
        "testStrategy": "1. **Testes de Instalação**:\n   - Verificar php artisan about mostra Laravel 12.x\n   - Verificar composer show filament/filament retorna ^4.0\n   - Acessar /admin e confirmar painel renderiza\n\n2. **Testes Funcionais Filament**:\n   - Criar credencial via painel: preencher form, validar campos obrigatórios\n   - Editar credencial existente e verificar atualização\n   - Soft delete e restore através do resource\n   - Testar filtros: secrecy, date range, status (ativo/expirado)\n   - Bulk actions: selecionar 10 registros e exportar Excel\n\n3. **Testes de Permissões**:\n   - Login como 'consulta': verificar que botões edit/delete não aparecem\n   - Login como 'admin': verificar acesso total ao CRUD\n   - Teste de policy: usuário sem permission tenta acessar rota direta (403)\n\n4. **Testes de Notificações**:\n   - Executar artisan check:expiring-credentials\n   - Verificar badge de notificações no menu\n   - Marcar notificação como lida\n\n5. **Testes de Performance**:\n   - Seed de 10.000 credenciais\n   - Teste de paginação com 100 registros por página\n   - Verificar queries com Debugbar (N+1 problems)\n   - Exportar PDF com 1000 registros (tempo < 10s)\n\n6. **Testes de Regressão**:\n   - Suite completa Pest: php artisan test\n   - Verificar todas features antigas funcionam\n   - Teste de validação de datas mantém regras\n   - Auditoria de exclusões funcionando\n\n7. **Testes de UI/UX**:\n   - Responsividade em mobile/tablet\n   - Traduções em pt-BR funcionando\n   - SweetAlert2 integrado com Filament notifications\n   - Performance do front-end (Lighthouse score > 90)",
        "status": "done",
        "dependencies": [
          "1",
          "2",
          "5",
          "6",
          "7",
          "8",
          "9",
          "10"
        ],
        "priority": "medium",
        "subtasks": [
          {
            "id": 1,
            "title": "Atualização de Dependências e Instalação do Laravel 12 com Filament 4",
            "description": "Atualizar composer.json para Laravel 12 e instalar Filament 4 com todas as dependências necessárias para o painel administrativo",
            "dependencies": [],
            "details": "Executar comandos de atualização do composer para Laravel 12.x e Filament 4.x. Instalar dependências complementares como spatie/laravel-permission ^6.0, filament-shield para gerenciamento de permissões, e configurar o painel administrativo básico. Verificar compatibilidade de todas as dependências existentes no composer.json atual com Laravel 12. Executar php artisan filament:install --panels e criar o primeiro usuário administrativo com php artisan make:filament-user. Configurar o AdminPanelProvider em app/Providers/Filament/ com configurações básicas de idioma (pt-BR), timezone e cores do tema.",
            "status": "done",
            "testStrategy": "Verificar que php artisan about exibe Laravel 12.x e composer show filament/filament retorna versão 4.x. Acessar /admin e confirmar que o painel renderiza corretamente. Testar login com usuário criado e verificar dashboard padrão do Filament.",
            "parentId": "undefined",
            "updatedAt": "2025-11-19T01:22:32.408Z"
          },
          {
            "id": 2,
            "title": "Migração de Models para Sintaxe do Laravel 12 e Configuração de Políticas",
            "description": "Atualizar todos os models (Credential, User) para sintaxe do Laravel 12, implementar método casts() como função, adicionar SoftDeletes e criar observers para auditoria",
            "dependencies": [
              1
            ],
            "details": "Refatorar app/Models/Credential.php e app/Models/User.php para usar protected function casts(): array em vez de propriedade. Atualizar casts para 'concession' => 'date', 'validity' => 'date', 'created_at' => 'datetime', 'updated_at' => 'datetime'. Implementar SoftDeletes trait e criar CredentialObserver para registrar eventos de criação, atualização e deleção. Adicionar scopes úteis como scopeExpired(), scopeExpiringSoon(), scopeActiveOnly() para facilitar queries. Criar policies com php artisan make:policy CredentialPolicy --model=Credential com métodos viewAny, view, create, update, delete, restore, forceDelete.",
            "status": "done",
            "testStrategy": "Executar php artisan tinker e testar Credential::factory()->create() para verificar casts funcionando. Testar soft delete e verificar deleted_at sendo preenchido. Testar scopes criados retornando resultados corretos. Verificar que policies são chamadas corretamente com Gate::allows().",
            "parentId": "undefined",
            "updatedAt": "2025-11-19T01:23:10.676Z"
          },
          {
            "id": 3,
            "title": "Criação de Resource Filament para Credenciais com Formulários e Tabelas",
            "description": "Desenvolver CredentialResource completo com formulários, tabelas, filtros e ações em massa utilizando Filament 4",
            "dependencies": [
              1,
              2
            ],
            "details": "Executar php artisan make:filament-resource Credential --generate --soft-deletes. Configurar form schema com TextInput para name e fscs, Select para secrecy com options ['OSTENSIVO', 'RESERVADO', 'CONFIDENCIAL', 'SECRETO'], DatePicker para concession e validity com validação customizada (validity deve ser >= hoje), Toggle para is_active. Implementar table com colunas name, fscs, secrecy (badge colorido), concession, validity (com indicador visual de expiração), is_active (icon boolean). Adicionar filters para secrecy (SelectFilter), status de validade (TernaryFilter), range de datas (DateRangeFilter). Criar bulk actions para exportação e deleção em massa. Implementar páginas customizadas: ViewCredential com tabs para dados básicos, histórico de alterações e anexos futuros.",
            "status": "done",
            "testStrategy": "Acessar /admin/credentials e verificar listagem renderizando. Criar nova credencial via formulário e validar que campos obrigatórios funcionam. Testar validação de data de validade (não aceitar datas passadas). Aplicar filtros diversos e verificar resultados. Testar soft delete e restore via actions. Verificar bulk actions funcionando com múltiplos registros selecionados.",
            "parentId": "undefined",
            "updatedAt": "2025-11-19T01:24:34.188Z"
          },
          {
            "id": 4,
            "title": "Implementação de Sistema de Permissões com Filament Shield e Spatie",
            "description": "Integrar Spatie Laravel Permission com Filament Shield, criar roles (super_admin, admin, consulta) e configurar políticas de acesso granulares",
            "dependencies": [
              1,
              2,
              3
            ],
            "details": "Instalar bezhansalleh/filament-shield e executar php artisan shield:install para gerar permissions automáticas. Criar roles no seeder: super_admin (all permissions), admin (view/create/update credentials), consulta (apenas view credentials). Configurar policies em CredentialPolicy usando can() do Spatie. Adicionar middleware no AdminPanelProvider para verificar permissões. Implementar navigation badges mostrando contagens apenas para usuários com permissão. Configurar grupos de navegação (Gestão, Relatórios, Configurações) com visibilidade baseada em permissões. Criar RoleResource e PermissionResource do Filament Shield para gerenciamento visual de permissões.",
            "status": "done",
            "testStrategy": "Criar usuário com role 'consulta' e verificar que não pode criar/editar credenciais. Criar usuário 'admin' e verificar acesso a CRUD completo mas não a configurações de roles. Logar como super_admin e verificar acesso total incluindo shield resources. Testar navigation items aparecendo/sumindo conforme permissões. Verificar que policies bloqueiam ações não autorizadas com mensagens apropriadas.",
            "parentId": "undefined",
            "updatedAt": "2025-11-19T01:25:03.794Z"
          },
          {
            "id": 5,
            "title": "Desenvolvimento de Widgets, Dashboard e Sistema de Notificações de Vencimento",
            "description": "Criar widgets para dashboard (estatísticas, gráficos, últimas credenciais) e implementar sistema de notificações automáticas para vencimentos",
            "dependencies": [
              1,
              2,
              3
            ],
            "details": "Criar StatsOverviewWidget com cards: total de credenciais (icon: heroicon-o-document-text), credenciais expirando em 30 dias (icon warning), credenciais já expiradas (icon danger). Desenvolver CredentialsBySecrecyChart usando ChartWidget tipo pie com dados agrupados por grau de sigilo. Criar LatestCredentialsWidget (TableWidget) mostrando últimas 10 credenciais criadas com links para edição. Implementar Command CheckExpiringCredentials que roda diariamente via Kernel schedule, verifica credenciais expirando em 30/7 dias e cria DatabaseNotifications. Configurar DatabaseNotification no painel Filament com título, corpo e ações (view credential). Adicionar badge no ícone de notificações mostrando contagem de não lidas. Criar migration para adicionar índices em validity para performance.",
            "status": "done",
            "testStrategy": "Acessar /admin e verificar todos os widgets renderizando com dados corretos. Executar php artisan app:check-expiring-credentials manualmente e verificar notificações sendo criadas. Verificar que notificações duplicadas não são geradas em execuções subsequentes. Testar clicando em notificação e sendo redirecionado para credencial. Verificar badge de contagem atualizando ao marcar como lida. Testar performance do command com 1000+ credenciais.",
            "parentId": "undefined",
            "updatedAt": "2025-11-19T01:25:05.489Z"
          }
        ],
        "updatedAt": "2025-11-19T01:25:05.489Z"
      },
      {
        "id": 12,
        "title": "Painel de Administração de Usuários com Sistema de Perfis e Permissões",
        "description": "Implementar Resource do Filament 4 para gerenciamento completo de usuários com integração ao Spatie Permission, incluindo ajuste da estrutura do banco para relacionamento users-credentials e criação de roles/permissions específicos para militares da aeronáutica.",
        "details": "1. **Ajuste de Estrutura do Banco de Dados**:\n   ```bash\n   php artisan make:migration add_user_id_to_credentials_table\n   ```\n   ```php\n   // Migration\n   public function up() {\n       Schema::table('credentials', function (Blueprint $table) {\n           $table->foreignId('user_id')->nullable()->after('id')->constrained('users')->nullOnDelete();\n           $table->index('user_id');\n       });\n   }\n   ```\n   - Atualizar Model Credential com relacionamento:\n   ```php\n   public function user() {\n       return $this->belongsTo(User::class);\n   }\n   ```\n   - Atualizar Model User:\n   ```php\n   public function credentials() {\n       return $this->hasMany(Credential::class);\n   }\n   ```\n\n2. **Configuração de Roles e Permissions com Spatie**:\n   - Criar Seeder RolesAndPermissionsSeeder:\n   ```php\n   // database/seeders/RolesAndPermissionsSeeder.php\n   use Spatie\\Permission\\Models\\Role;\n   use Spatie\\Permission\\Models\\Permission;\n   \n   public function run() {\n       app()[\\Spatie\\Permission\\PermissionRegistrar::class]->forgetCachedPermissions();\n       \n       // Criar permissions\n       $permissions = [\n           'view_users', 'create_users', 'edit_users', 'delete_users',\n           'view_credentials', 'create_credentials', 'edit_credentials', 'delete_credentials',\n           'view_audit_logs', 'export_reports', 'manage_permissions'\n       ];\n       \n       foreach ($permissions as $permission) {\n           Permission::create(['name' => $permission]);\n       }\n       \n       // Criar roles\n       $superAdmin = Role::create(['name' => 'Super Admin']);\n       $superAdmin->givePermissionTo(Permission::all());\n       \n       $admin = Role::create(['name' => 'Administrador']);\n       $admin->givePermissionTo([\n           'view_users', 'create_users', 'edit_users',\n           'view_credentials', 'create_credentials', 'edit_credentials', 'delete_credentials',\n           'view_audit_logs', 'export_reports'\n       ]);\n       \n       $operador = Role::create(['name' => 'Operador']);\n       $operador->givePermissionTo([\n           'view_credentials', 'create_credentials', 'edit_credentials',\n           'view_audit_logs'\n       ]);\n       \n       $consulta = Role::create(['name' => 'Consulta']);\n       $consulta->givePermissionTo(['view_credentials', 'view_audit_logs']);\n   }\n   ```\n\n3. **Implementação do UserResource no Filament 4**:\n   ```bash\n   php artisan make:filament-resource User --generate\n   ```\n   ```php\n   // app/Filament/Resources/UserResource.php\n   use Filament\\Forms\\Components\\{TextInput, Select, CheckboxList};\n   use Filament\\Tables\\Columns\\{TextColumn, BadgeColumn};\n   use Spatie\\Permission\\Models\\Role;\n   \n   public static function form(Form $form): Form {\n       return $form->schema([\n           TextInput::make('name')\n               ->required()\n               ->maxLength(255)\n               ->label('Nome Completo'),\n           \n           TextInput::make('email')\n               ->email()\n               ->required()\n               ->unique(ignoreRecord: true)\n               ->label('E-mail'),\n           \n           TextInput::make('password')\n               ->password()\n               ->required(fn ($livewire) => $livewire instanceof CreateRecord)\n               ->dehydrateStateUsing(fn ($state) => Hash::make($state))\n               ->dehydrated(fn ($state) => filled($state))\n               ->label('Senha'),\n           \n           Select::make('roles')\n               ->relationship('roles', 'name')\n               ->multiple()\n               ->preload()\n               ->searchable()\n               ->label('Perfis')\n               ->helperText('Selecione um ou mais perfis para o usuário'),\n           \n           CheckboxList::make('permissions')\n               ->relationship('permissions', 'name')\n               ->columns(3)\n               ->label('Permissões Adicionais')\n               ->helperText('Permissões específicas além das do perfil')\n       ]);\n   }\n   \n   public static function table(Table $table): Table {\n       return $table\n           ->columns([\n               TextColumn::make('name')\n                   ->searchable()\n                   ->sortable()\n                   ->label('Nome'),\n               \n               TextColumn::make('email')\n                   ->searchable()\n                   ->sortable()\n                   ->label('E-mail'),\n               \n               BadgeColumn::make('roles.name')\n                   ->label('Perfis')\n                   ->colors([\n                       'danger' => 'Super Admin',\n                       'warning' => 'Administrador',\n                       'success' => 'Operador',\n                       'primary' => 'Consulta',\n                   ]),\n               \n               TextColumn::make('credentials_count')\n                   ->counts('credentials')\n                   ->label('Credenciais'),\n               \n               TextColumn::make('created_at')\n                   ->dateTime('d/m/Y H:i')\n                   ->sortable()\n                   ->label('Criado em')\n           ])\n           ->filters([\n               SelectFilter::make('roles')\n                   ->relationship('roles', 'name')\n                   ->label('Filtrar por Perfil'),\n               \n               Filter::make('has_credentials')\n                   ->query(fn (Builder $query) => $query->has('credentials'))\n                   ->label('Com Credenciais')\n           ])\n           ->actions([\n               Tables\\Actions\\EditAction::make(),\n               Tables\\Actions\\DeleteAction::make()\n           ])\n           ->bulkActions([\n               Tables\\Actions\\DeleteBulkAction::make()\n           ]);\n   }\n   ```\n\n4. **Implementação de Policies para UserResource**:\n   ```bash\n   php artisan make:policy UserPolicy --model=User\n   ```\n   ```php\n   // app/Policies/UserPolicy.php\n   public function viewAny(User $user): bool {\n       return $user->can('view_users');\n   }\n   \n   public function create(User $user): bool {\n       return $user->can('create_users');\n   }\n   \n   public function update(User $user, User $model): bool {\n       return $user->can('edit_users');\n   }\n   \n   public function delete(User $user, User $model): bool {\n       return $user->can('delete_users') && $model->id !== $user->id;\n   }\n   ```\n   - Registrar policy em AuthServiceProvider:\n   ```php\n   protected $policies = [\n       User::class => UserPolicy::class,\n   ];\n   ```\n\n5. **Configuração do Filament Shield Plugin**:\n   ```bash\n   composer require bezhansalleh/filament-shield\n   php artisan vendor:publish --tag=filament-shield-config\n   php artisan shield:install\n   ```\n   - Adicionar plugin ao AdminPanelProvider:\n   ```php\n   use BezhanSalleh\\FilamentShield\\FilamentShieldPlugin;\n   \n   public function panel(Panel $panel): Panel {\n       return $panel\n           ->plugin(FilamentShieldPlugin::make());\n   }\n   ```\n\n6. **Widget de Auditoria de Usuários no Dashboard**:\n   ```bash\n   php artisan make:filament-widget UserActivityWidget\n   ```\n   ```php\n   // app/Filament/Widgets/UserActivityWidget.php\n   use Filament\\Widgets\\StatsOverviewWidget;\n   \n   protected function getStats(): array {\n       return [\n           Stat::make('Total de Usuários', User::count()),\n           Stat::make('Administradores', User::role('Administrador')->count()),\n           Stat::make('Operadores', User::role('Operador')->count()),\n           Stat::make('Usuários Ativos (30 dias)', User::where('last_login_at', '>=', now()->subDays(30))->count()),\n       ];\n   }\n   ```\n\n7. **Integração com CredentialResource**:\n   - Atualizar CredentialResource para incluir filtro por usuário:\n   ```php\n   SelectFilter::make('user')\n       ->relationship('user', 'name')\n       ->searchable()\n       ->preload()\n       ->label('Filtrar por Usuário'),\n   ```\n   - Adicionar coluna na tabela:\n   ```php\n   TextColumn::make('user.name')\n       ->searchable()\n       ->sortable()\n       ->label('Usuário Responsável'),\n   ```\n\n8. **Tradução e Localização**:\n   - Publicar traduções do Filament Shield:\n   ```bash\n   php artisan vendor:publish --tag=filament-shield-translations\n   ```\n   - Customizar lang/pt_BR/filament-shield.php com termos militares",
        "testStrategy": "1. **Testes de Migração e Relacionamentos**:\n   - Executar migrations e verificar estrutura: php artisan migrate:fresh --seed\n   - Teste unitário verificando relacionamento User->credentials retorna Collection\n   - Teste que credentials->user retorna instância de User\n   - Verificar constraint de foreign key e comportamento nullOnDelete\n\n2. **Testes de Seeder de Roles/Permissions**:\n   - Executar php artisan db:seed --class=RolesAndPermissionsSeeder\n   - Verificar que 4 roles foram criadas (Super Admin, Administrador, Operador, Consulta)\n   - Verificar que 11 permissions foram criadas\n   - Teste que Super Admin possui todas permissions\n   - Teste que Consulta possui apenas view_credentials e view_audit_logs\n\n3. **Testes Funcionais do UserResource no Filament**:\n   - Acessar /admin/users como Super Admin e verificar listagem\n   - Criar novo usuário com perfil 'Operador' via painel\n   - Editar usuário e adicionar permission adicional 'export_reports'\n   - Verificar filtro por perfil retorna usuários corretos\n   - Teste que usuário não pode deletar a si mesmo\n\n4. **Testes de Policy e Autorização**:\n   - Login como usuário 'Consulta' e verificar que /admin/users retorna 403\n   - Login como 'Administrador' e verificar acesso a create/edit users\n   - Teste que 'Operador' não vê menu de usuários\n   - Verificar que Super Admin bypassa todas policies\n\n5. **Testes de Integração User-Credential**:\n   - Criar credencial e verificar que user_id é preenchido automaticamente\n   - Filtrar credenciais por usuário no painel\n   - Verificar contador 'credentials_count' na listagem de usuários\n   - Teste que ao deletar usuário, suas credenciais ficam com user_id = null\n\n6. **Testes de Performance e UI**:\n   - Criar 100 usuários via factory e verificar performance da listagem\n   - Teste de busca por nome/email com dataset grande\n   - Verificar responsividade do formulário em mobile\n   - Teste de badges de roles renderizando cores corretas\n\n7. **Testes de Auditoria**:\n   - Verificar que criação de usuário gera log de auditoria (se Task 3 implementada)\n   - Teste que mudança de role é registrada no audit log\n   - Verificar IP e user_agent capturados corretamente",
        "status": "done",
        "dependencies": [
          "11",
          "2",
          "4"
        ],
        "priority": "medium",
        "subtasks": [
          {
            "id": 1,
            "title": "Ajustar estrutura do banco de dados para relacionamento users-credentials",
            "description": "Criar migration para adicionar coluna user_id na tabela credentials e atualizar os Models User e Credential com relacionamentos hasMany e belongsTo",
            "dependencies": [],
            "details": "Executar `php artisan make:migration add_user_id_to_credentials_table` e implementar a migration adicionando `$table->foreignId('user_id')->nullable()->after('id')->constrained('users')->nullOnDelete()` com índice. Atualizar Model Credential adicionando método `user()` retornando `$this->belongsTo(User::class)`. Atualizar Model User adicionando método `credentials()` retornando `$this->hasMany(Credential::class)`. Executar migration com `php artisan migrate`.",
            "status": "done",
            "testStrategy": "Executar migration e verificar estrutura da tabela credentials com `php artisan migrate`. Testar relacionamento criando um usuário e associando credenciais, verificando que `$user->credentials` retorna Collection e `$credential->user` retorna instância de User. Verificar que a constraint nullOnDelete funciona corretamente deletando um usuário.",
            "parentId": "undefined",
            "updatedAt": "2025-11-19T19:49:06.452Z"
          },
          {
            "id": 2,
            "title": "Configurar sistema de roles e permissions com Spatie Permission",
            "description": "Criar seeder RolesAndPermissionsSeeder implementando roles (Super Admin, Administrador, Operador, Consulta) e permissions específicas para gerenciamento de usuários e credenciais no contexto militar",
            "dependencies": [],
            "details": "Criar arquivo `database/seeders/RolesAndPermissionsSeeder.php` implementando método `run()` que: 1) limpa cache de permissions com `app()[PermissionRegistrar::class]->forgetCachedPermissions()`, 2) cria permissions (view_users, create_users, edit_users, delete_users, view_credentials, create_credentials, edit_credentials, delete_credentials, view_audit_logs, export_reports, manage_permissions), 3) cria roles e atribui permissions específicas para cada perfil conforme hierarquia militar. Registrar seeder no DatabaseSeeder e executar com `php artisan db:seed --class=RolesAndPermissionsSeeder`.",
            "status": "done",
            "testStrategy": "Executar seeder com `php artisan db:seed --class=RolesAndPermissionsSeeder` e verificar criação de 4 roles e 11 permissions no banco de dados. Testar atribuição de permissions verificando que Super Admin possui todas as permissions, Administrador possui permissions de gerenciamento exceto delete_users e manage_permissions, Operador possui permissions limitadas de CRUD de credenciais, e Consulta possui apenas view.",
            "parentId": "undefined",
            "updatedAt": "2025-11-19T19:50:53.035Z"
          },
          {
            "id": 3,
            "title": "Implementar UserResource no Filament 4 com formulários e tabelas",
            "description": "Criar Resource completo do Filament para gerenciamento de usuários incluindo form com campos de perfis e permissions, table com colunas e filtros, e integração com Spatie Permission",
            "dependencies": [
              2
            ],
            "details": "Executar `php artisan make:filament-resource User --generate` e customizar app/Filament/Resources/UserResource.php implementando: 1) método `form()` com TextInput para name e email, password com hash e dehydration condicional, Select multiple para roles com relationship, CheckboxList para permissions adicionais, 2) método `table()` com TextColumn para name e email searchable/sortable, BadgeColumn para roles.name com cores específicas, credentials_count, created_at formatado, 3) filters com SelectFilter para roles e Filter para has_credentials, 4) actions de Edit e Delete, 5) bulkActions com DeleteBulkAction.",
            "status": "done",
            "testStrategy": "Acessar painel Filament e verificar que UserResource aparece no menu. Testar criação de novo usuário preenchendo todos os campos e atribuindo roles/permissions. Verificar que senha é hashada corretamente. Testar edição mantendo senha existente quando campo vazio. Verificar que filtros funcionam corretamente e badges de roles exibem cores apropriadas. Testar ordenação e busca nas colunas.",
            "parentId": "undefined",
            "updatedAt": "2025-11-19T19:58:37.150Z"
          },
          {
            "id": 4,
            "title": "Criar e registrar UserPolicy para controle de acesso baseado em permissions",
            "description": "Implementar Policy class para User com métodos viewAny, create, update e delete verificando permissions do Spatie, incluindo proteção contra auto-exclusão, e registrar no AuthServiceProvider",
            "dependencies": [
              2
            ],
            "details": "Executar `php artisan make:policy UserPolicy --model=User` e implementar métodos: `viewAny()` retornando `$user->can('view_users')`, `create()` retornando `$user->can('create_users')`, `update()` retornando `$user->can('edit_users')`, `delete()` retornando `$user->can('delete_users') && $model->id !== $user->id` para evitar auto-exclusão. Registrar policy em `app/Providers/AuthServiceProvider.php` adicionando `User::class => UserPolicy::class` no array `$policies`.",
            "status": "done",
            "testStrategy": "Criar usuários com diferentes roles e testar acesso ao UserResource verificando que apenas usuários com permissions adequadas conseguem visualizar, criar, editar e deletar. Testar especificamente que usuário não consegue deletar a si próprio. Verificar que usuários sem permission view_users não conseguem acessar o resource. Testar que Super Admin tem acesso total.",
            "parentId": "undefined",
            "updatedAt": "2025-11-19T19:58:38.694Z"
          },
          {
            "id": 5,
            "title": "Integrar CredentialResource com sistema de usuários e adicionar widget de auditoria",
            "description": "Atualizar CredentialResource adicionando relacionamento com User (filtro e coluna), criar UserActivityWidget para dashboard mostrando estatísticas de usuários por role, e configurar traduções pt_BR",
            "dependencies": [
              1,
              3
            ],
            "details": "Atualizar `app/Filament/Resources/CredentialResource.php` adicionando: 1) SelectFilter para user com `->relationship('user', 'name')->searchable()->preload()`, 2) TextColumn `user.name` na table. Executar `php artisan make:filament-widget UserActivityWidget` e implementar `getStats()` retornando array com Stat::make para total de usuários, count por role (Administrador, Operador), e usuários ativos nos últimos 30 dias. Publicar traduções do Spatie com `php artisan vendor:publish --tag=filament-shield-translations` e customizar lang/pt_BR/filament-shield.php.",
            "status": "done",
            "testStrategy": "Acessar CredentialResource e verificar que coluna de usuário responsável aparece e é searchable/sortable. Testar filtro por usuário verificando que apenas credentials do usuário selecionado são exibidas. Acessar dashboard e verificar que UserActivityWidget exibe estatísticas corretas. Criar, editar e deletar usuários verificando que contadores atualizam. Verificar que todas as labels estão em português brasileiro.",
            "parentId": "undefined",
            "updatedAt": "2025-11-19T20:03:25.492Z"
          }
        ],
        "updatedAt": "2025-11-19T20:03:25.492Z"
      },
      {
        "id": 13,
        "title": "Implementar Sistema de Auditoria (Audit Logs)",
        "description": "Criar tabela audit_logs para rastrear todas as operações CRUD no sistema, incluindo visualizações de credenciais. Sistema deve registrar: usuário, ação, dados anteriores/novos, IP, user agent, timestamp.",
        "details": "1. **Criar Migration para Tabela audit_logs**:\n   ```bash\n   php artisan make:migration create_audit_logs_table\n   ```\n   ```php\n   public function up() {\n       Schema::create('audit_logs', function (Blueprint $table) {\n           $table->id();\n           $table->foreignId('user_id')->nullable()->constrained('users')->nullOnDelete();\n           $table->string('auditable_type')->nullable();\n           $table->unsignedBigInteger('auditable_id')->nullable();\n           $table->string('action'); // created, updated, deleted, viewed, restored\n           $table->json('old_values')->nullable();\n           $table->json('new_values')->nullable();\n           $table->ipAddress('ip_address')->nullable();\n           $table->text('user_agent')->nullable();\n           $table->timestamp('created_at');\n           $table->index(['auditable_type', 'auditable_id']);\n           $table->index('user_id');\n           $table->index('action');\n           $table->index('created_at');\n       });\n   }\n   ```\n\n2. **Criar Model AuditLog**:\n   ```php\n   namespace App\\Models;\n   \n   use Illuminate\\Database\\Eloquent\\Model;\n   \n   class AuditLog extends Model {\n       public $timestamps = false;\n       protected $fillable = ['user_id', 'auditable_type', 'auditable_id', 'action', 'old_values', 'new_values', 'ip_address', 'user_agent', 'created_at'];\n       protected $casts = ['old_values' => 'array', 'new_values' => 'array', 'created_at' => 'datetime'];\n       \n       public function user() {\n           return $this->belongsTo(User::class);\n       }\n       \n       public function auditable() {\n           return $this->morphTo();\n       }\n   }\n   ```\n\n3. **Criar Trait Auditable para Models**:\n   ```php\n   namespace App\\Traits;\n   \n   use App\\Models\\AuditLog;\n   use Illuminate\\Support\\Facades\\Auth;\n   \n   trait Auditable {\n       protected static function bootAuditable() {\n           static::created(function ($model) {\n               $model->logAudit('created', null, $model->getAuditableAttributes());\n           });\n           \n           static::updated(function ($model) {\n               $model->logAudit('updated', $model->getOriginal(), $model->getAuditableAttributes());\n           });\n           \n           static::deleted(function ($model) {\n               $model->logAudit('deleted', $model->getAuditableAttributes(), null);\n           });\n       }\n       \n       public function logAudit($action, $oldValues = null, $newValues = null) {\n           AuditLog::create([\n               'user_id' => Auth::id(),\n               'auditable_type' => get_class($this),\n               'auditable_id' => $this->id,\n               'action' => $action,\n               'old_values' => $oldValues,\n               'new_values' => $newValues,\n               'ip_address' => request()->ip(),\n               'user_agent' => request()->userAgent(),\n               'created_at' => now()\n           ]);\n       }\n       \n       protected function getAuditableAttributes() {\n           return $this->only($this->auditableFields ?? array_keys($this->getAttributes()));\n       }\n       \n       public function auditLogs() {\n           return $this->morphMany(AuditLog::class, 'auditable');\n       }\n   }\n   ```\n\n4. **Adicionar Trait ao Model Credential**:\n   ```php\n   use App\\Traits\\Auditable;\n   \n   class Credential extends Model {\n       use Auditable, SoftDeletes;\n       \n       protected $auditableFields = ['name', 'fscs', 'secrecy', 'concession', 'validity', 'status', 'user_id'];\n   }\n   ```\n\n5. **Implementar Log de Visualizações no CredentialResource (Filament)**:\n   ```php\n   use App\\Models\\AuditLog;\n   \n   public static function table(Table $table): Table {\n       return $table\n           ->recordAction(function ($record) {\n               AuditLog::create([\n                   'user_id' => auth()->id(),\n                   'auditable_type' => Credential::class,\n                   'auditable_id' => $record->id,\n                   'action' => 'viewed',\n                   'ip_address' => request()->ip(),\n                   'user_agent' => request()->userAgent(),\n                   'created_at' => now()\n               ]);\n           });\n   }\n   ```\n\n6. **Criar Filament Resource para AuditLogs**:\n   ```bash\n   php artisan make:filament-resource AuditLog --view\n   ```\n   ```php\n   public static function table(Table $table): Table {\n       return $table\n           ->columns([\n               TextColumn::make('user.name')->label('Usuário')->sortable()->searchable(),\n               TextColumn::make('action')->label('Ação')->badge()->color(fn (string $state): string => match ($state) {\n                   'created' => 'success',\n                   'updated' => 'warning',\n                   'deleted' => 'danger',\n                   'viewed' => 'info',\n                   default => 'gray',\n               }),\n               TextColumn::make('auditable_type')->label('Tipo')->formatStateUsing(fn ($state) => class_basename($state)),\n               TextColumn::make('ip_address')->label('IP'),\n               TextColumn::make('created_at')->label('Data/Hora')->dateTime('d/m/Y H:i:s')->sortable(),\n           ])\n           ->filters([\n               SelectFilter::make('action')->options([\n                   'created' => 'Criado',\n                   'updated' => 'Atualizado',\n                   'deleted' => 'Deletado',\n                   'viewed' => 'Visualizado'\n               ]),\n               Filter::make('created_at')->form([\n                   DatePicker::make('created_from')->label('De'),\n                   DatePicker::make('created_until')->label('Até'),\n               ])\n           ])\n           ->defaultSort('created_at', 'desc');\n   }\n   \n   public static function infolist(Infolist $infolist): Infolist {\n       return $infolist\n           ->schema([\n               TextEntry::make('user.name')->label('Usuário'),\n               TextEntry::make('action')->label('Ação'),\n               TextEntry::make('old_values')->label('Valores Anteriores')->formatStateUsing(fn ($state) => json_encode($state, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE)),\n               TextEntry::make('new_values')->label('Valores Novos')->formatStateUsing(fn ($state) => json_encode($state, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE)),\n               TextEntry::make('ip_address')->label('Endereço IP'),\n               TextEntry::make('user_agent')->label('User Agent'),\n               TextEntry::make('created_at')->label('Data/Hora')->dateTime('d/m/Y H:i:s'),\n           ]);\n   }\n   ```\n\n7. **Configurar Permissões (Spatie Permission)**:\n   ```php\n   // Em RolesSeeder ou equivalente\n   Permission::create(['name' => 'view_audit_logs']);\n   Permission::create(['name' => 'view_any_audit_logs']);\n   \n   $adminRole->givePermissionTo(['view_audit_logs', 'view_any_audit_logs']);\n   ```\n\n8. **Adicionar Policy para restringir acesso**:\n   ```bash\n   php artisan make:policy AuditLogPolicy --model=AuditLog\n   ```\n   ```php\n   public function viewAny(User $user): bool {\n       return $user->hasPermissionTo('view_any_audit_logs');\n   }\n   \n   public function view(User $user, AuditLog $auditLog): bool {\n       return $user->hasPermissionTo('view_audit_logs');\n   }\n   ```",
        "testStrategy": "1. **Testes Unitários de Auditoria**:\n   - Criar teste verificando que ao criar Credential, AuditLog é criado com action='created'\n   - Testar que old_values é null em criação e new_values contém dados corretos\n   - Testar que ao atualizar Credential, old_values captura estado anterior e new_values o novo estado\n   - Verificar que ao deletar (soft delete), action='deleted' e old_values está preenchido\n   - Testar que user_id, ip_address e user_agent são capturados corretamente\n\n2. **Testes de Integração com Filament**:\n   - Acessar /admin/audit-logs e verificar que tabela renderiza\n   - Testar filtros por ação (created, updated, deleted, viewed)\n   - Testar filtro por período (created_from/created_until)\n   - Verificar que usuário sem permissão 'view_any_audit_logs' não acessa recurso\n   - Testar visualização de detalhes do log (infolist) exibe JSON formatado\n\n3. **Testes de Log de Visualizações**:\n   - Acessar detalhes de uma credencial e verificar que AuditLog com action='viewed' é criado\n   - Verificar que múltiplas visualizações da mesma credencial criam múltiplos logs\n\n4. **Testes de Performance**:\n   - Criar 10.000 audit logs e verificar que queries usam índices (EXPLAIN)\n   - Testar paginação com dataset grande não degrada performance\n   - Verificar que relacionamentos são eager loaded (N+1 query prevention)\n\n5. **Testes de Integridade de Dados**:\n   - Verificar que ao deletar usuário, audit_logs associados mantêm user_id null (nullOnDelete)\n   - Testar que JSON em old_values/new_values é válido e parseável\n   - Verificar que timestamps são UTC e exibidos no timezone correto",
        "status": "pending",
        "dependencies": [
          "2",
          "11"
        ],
        "priority": "medium",
        "subtasks": [
          {
            "id": 1,
            "title": "Criar Migration e Model AuditLog",
            "description": "Criar migration para tabela audit_logs com todos os campos necessários (user_id, auditable_type, auditable_id, action, old_values, new_values, ip_address, user_agent) e índices apropriados. Criar Model AuditLog com casts, fillable e relacionamentos.",
            "dependencies": [],
            "details": "Executar 'php artisan make:migration create_audit_logs_table' e implementar schema com foreignId para user_id, campos auditable_type/auditable_id para polimorfismo, string para action, json para old_values/new_values, ipAddress para ip_address, text para user_agent e timestamp para created_at. Adicionar índices compostos e simples. Criar Model em app/Models/AuditLog.php com $timestamps=false, $fillable array completo, $casts para arrays e datetime, método user() retornando belongsTo(User::class) e método auditable() retornando morphTo().",
            "status": "pending",
            "testStrategy": "Executar migration e verificar estrutura da tabela com 'php artisan migrate' e inspeção do banco. Testar instanciação do Model e verificar casts funcionando corretamente. Validar relacionamentos com factories de teste.",
            "parentId": "undefined"
          },
          {
            "id": 2,
            "title": "Implementar Trait Auditable para rastreamento automático",
            "description": "Criar trait Auditable em app/Traits/Auditable.php que capture automaticamente eventos created, updated e deleted dos models, registrando no AuditLog com IP, user agent e valores anteriores/novos.",
            "dependencies": [
              1
            ],
            "details": "Implementar bootAuditable() com static::created/updated/deleted observers. Criar método logAudit($action, $oldValues, $newValues) que cria registro em AuditLog capturando Auth::id(), get_class($this), $this->id, request()->ip() e request()->userAgent(). Implementar getAuditableAttributes() que respeita propriedade $auditableFields se definida, caso contrário retorna todos atributos. Adicionar método auditLogs() retornando morphMany(AuditLog::class, 'auditable').",
            "status": "pending",
            "testStrategy": "Criar teste unitário verificando que ao criar/atualizar/deletar model com trait, AuditLog é criado automaticamente. Verificar que old_values captura estado anterior em updates, é null em created e contém dados em deleted. Validar que IP e user agent são capturados corretamente. Testar $auditableFields limitando campos auditados.",
            "parentId": "undefined"
          },
          {
            "id": 3,
            "title": "Adicionar Trait Auditable ao Model Credential",
            "description": "Integrar trait Auditable ao model Credential existente em app/Models/Credential.php, definindo campos auditáveis específicos (name, fscs, secrecy, concession, validity, status, user_id).",
            "dependencies": [
              2
            ],
            "details": "Adicionar 'use App\\Traits\\Auditable;' no topo do arquivo e incluir Auditable no use statement da classe após SoftDeletes. Definir propriedade protected $auditableFields com array contendo 'name', 'fscs', 'secrecy', 'concession', 'validity', 'status', 'user_id'. Garantir compatibilidade com SoftDeletes existente, verificando que eventos de restore também podem ser auditados se necessário.",
            "status": "pending",
            "testStrategy": "Criar teste feature verificando que operações CRUD em Credential geram AuditLog automaticamente. Testar criação de credencial e verificar action='created' com new_values preenchido. Testar update verificando old_values e new_values. Testar soft delete verificando registro de auditoria. Validar que apenas campos em $auditableFields são registrados.",
            "parentId": "undefined"
          },
          {
            "id": 4,
            "title": "Criar AuditLogResource no Filament com visualização completa",
            "description": "Criar Filament Resource para AuditLog com tabela exibindo usuário, ação, tipo, IP e data/hora, filtros por ação e data, e infolist mostrando detalhes completos incluindo old_values/new_values formatados em JSON.",
            "dependencies": [
              1
            ],
            "details": "Executar 'php artisan make:filament-resource AuditLog --view' para resource somente leitura. Implementar table() com TextColumn para user.name (sortable/searchable), action com badge e cores (success/warning/danger/info), auditable_type formatado com class_basename(), ip_address e created_at formatado 'd/m/Y H:i:s'. Adicionar SelectFilter para action e Filter de created_at com DatePicker from/until. Implementar infolist() com TextEntry para todos campos, formatando old_values/new_values com json_encode(JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE). DefaultSort por created_at desc.",
            "status": "pending",
            "testStrategy": "Testar acesso ao resource via Filament admin panel. Verificar listagem de audit logs com dados corretos. Testar filtros por ação e intervalo de datas. Validar visualização de detalhes com old_values/new_values exibidos corretamente em JSON formatado. Testar ordenação por data. Verificar badges de ação com cores corretas.",
            "parentId": "undefined"
          },
          {
            "id": 5,
            "title": "Implementar log de visualizações e configurar permissões",
            "description": "Adicionar logging de visualizações de credenciais no CredentialResource do Filament, criar permissões view_audit_logs/view_any_audit_logs, criar AuditLogPolicy e configurar restrições de acesso apenas para administradores.",
            "dependencies": [
              3,
              4
            ],
            "details": "No CredentialResource, implementar recordAction ou hook apropriado do Filament para capturar visualizações, criando AuditLog com action='viewed' sem old_values/new_values. Executar 'php artisan make:policy AuditLogPolicy --model=AuditLog' e implementar viewAny() e view() verificando hasPermissionTo. Criar migrations ou adicionar em seeder existente as permissões 'view_audit_logs' e 'view_any_audit_logs'. Atribuir permissões ao role admin. Registrar policy no AuthServiceProvider ou usar descoberta automática do Laravel 11.",
            "status": "pending",
            "testStrategy": "Testar que ao visualizar detalhes de credencial no Filament, AuditLog com action='viewed' é criado. Verificar que usuário sem permissão não consegue acessar AuditLogResource. Testar que admin consegue visualizar audit logs. Validar que view logs aparecem na listagem separados de create/update/delete. Verificar IP e user agent em logs de visualização.",
            "parentId": "undefined"
          }
        ]
      },
      {
        "id": 14,
        "title": "Adicionar Índices de Performance no Banco de Dados",
        "description": "Criar índices adicionais nas tabelas credentials e users para otimizar performance das consultas mais frequentes, incluindo análise de query patterns e implementação de índices compostos.",
        "details": "1. **Análise de Queries Atuais**:\n   ```bash\n   # Habilitar query logging temporariamente\n   DB::enableQueryLog();\n   # Analisar queries no Telescope ou logs\n   ```\n   - Identificar queries N+1 em relacionamentos\n   - Analisar queries de filtros e ordenações frequentes\n   - Verificar queries de busca com LIKE\n\n2. **Criar Migration de Índices**:\n   ```bash\n   php artisan make:migration add_performance_indexes_to_credentials_and_users\n   ```\n   ```php\n   public function up() {\n       Schema::table('credentials', function (Blueprint $table) {\n           // Índice simples para validity (filtro comum)\n           $table->index('validity', 'idx_credentials_validity');\n           \n           // Índice para created_at (ordenação temporal)\n           $table->index('created_at', 'idx_credentials_created_at');\n           \n           // Índice para fscs (busca/filtro)\n           $table->index('fscs', 'idx_credentials_fscs');\n           \n           // Índice composto para queries que filtram por validade e ordenam por data\n           $table->index(['validity', 'created_at'], 'idx_credentials_validity_created');\n           \n           // Índice composto para auditoria (user_id + created_at)\n           if (Schema::hasColumn('credentials', 'user_id')) {\n               $table->index(['user_id', 'created_at'], 'idx_credentials_user_created');\n           }\n           \n           // Índice para soft deletes se existir\n           if (Schema::hasColumn('credentials', 'deleted_at')) {\n               $table->index('deleted_at', 'idx_credentials_deleted_at');\n           }\n       });\n\n       Schema::table('users', function (Blueprint $table) {\n           // Índice para created_at\n           $table->index('created_at', 'idx_users_created_at');\n           \n           // Índice para email (se não existir unique já)\n           if (!Schema::hasColumn('users', 'email')) {\n               $table->index('email', 'idx_users_email');\n           }\n           \n           // Índice composto para filtros com role\n           if (Schema::hasColumn('users', 'role')) {\n               $table->index(['role', 'created_at'], 'idx_users_role_created');\n           }\n       });\n   }\n\n   public function down() {\n       Schema::table('credentials', function (Blueprint $table) {\n           $table->dropIndex('idx_credentials_validity');\n           $table->dropIndex('idx_credentials_created_at');\n           $table->dropIndex('idx_credentials_fscs');\n           $table->dropIndex('idx_credentials_validity_created');\n           if (Schema::hasColumn('credentials', 'user_id')) {\n               $table->dropIndex('idx_credentials_user_created');\n           }\n           if (Schema::hasColumn('credentials', 'deleted_at')) {\n               $table->dropIndex('idx_credentials_deleted_at');\n           }\n       });\n\n       Schema::table('users', function (Blueprint $table) {\n           $table->dropIndex('idx_users_created_at');\n           if (Schema::hasColumn('users', 'role')) {\n               $table->dropIndex('idx_users_role_created');\n           }\n       });\n   }\n   ```\n\n3. **Otimização de Queries no Filament**:\n   - Em CredentialResource.php, adicionar eager loading:\n   ```php\n   public static function getEloquentQuery(): Builder\n   {\n       return parent::getEloquentQuery()\n           ->with(['user', 'creator', 'updater'])\n           ->withCount('auditLogs');\n   }\n   ```\n   - Adicionar índices em queries customizadas:\n   ```php\n   // Exemplo de query otimizada\n   Credential::where('validity', '>', now())\n       ->orderBy('created_at', 'desc')\n       ->get(); // Usará idx_credentials_validity_created\n   ```\n\n4. **Análise de Performance com Laravel Debugbar**:\n   ```bash\n   composer require barryvdh/laravel-debugbar --dev\n   ```\n   - Verificar número de queries\n   - Analisar tempo de execução\n   - Identificar queries lentas\n\n5. **Documentação dos Índices**:\n   - Criar arquivo docs/database_indexes.md explicando:\n     - Propósito de cada índice\n     - Queries que serão beneficiadas\n     - Impacto em INSERT/UPDATE (trade-off)\n\n6. **Considerações Importantes**:\n   - Índices aumentam velocidade de SELECT mas podem reduzir INSERT/UPDATE\n   - Monitorar tamanho dos índices com `SHOW INDEX FROM credentials`\n   - Avaliar necessidade de índices FULLTEXT para buscas textuais\n   - Considerar particionamento de tabela se volume crescer muito (>1M registros)",
        "testStrategy": "1. **Teste de Performance Before/After**:\n   ```bash\n   # Criar seeder com 10k registros\n   php artisan db:seed --class=PerformanceTestSeeder\n   ```\n   - Executar queries típicas ANTES da migration e registrar tempo\n   - Executar migration com índices\n   - Executar mesmas queries e comparar tempo (deve reduzir 50-80%)\n\n2. **Verificar Criação dos Índices**:\n   ```sql\n   SHOW INDEX FROM credentials;\n   SHOW INDEX FROM users;\n   ```\n   - Confirmar todos índices listados no schema existem\n   - Verificar cardinalidade dos índices (deve ser alta)\n\n3. **Teste com EXPLAIN no MySQL**:\n   ```sql\n   EXPLAIN SELECT * FROM credentials WHERE validity > NOW() ORDER BY created_at DESC;\n   ```\n   - Verificar que coluna 'key' mostra índice sendo usado\n   - Confirmar 'type' é 'range' ou 'index' (não 'ALL')\n\n4. **Teste de Regressão**:\n   - Executar suite completa de testes (Task 10) após migration\n   - Verificar que nenhuma funcionalidade quebrou\n   - Confirmar tempo de execução dos testes reduziu\n\n5. **Monitoramento com Laravel Debugbar**:\n   - Acessar lista de credentials no Filament\n   - Verificar quantidade de queries (deve ser <10 com eager loading)\n   - Confirmar tempo de carregamento <200ms para 100 registros\n\n6. **Teste de Rollback**:\n   ```bash\n   php artisan migrate:rollback --step=1\n   ```\n   - Verificar que índices foram removidos corretamente\n   - Confirmar aplicação continua funcionando\n\n7. **Análise de Tamanho**:\n   ```sql\n   SELECT \n       table_name,\n       ROUND(((data_length + index_length) / 1024 / 1024), 2) AS 'Size (MB)'\n   FROM information_schema.TABLES\n   WHERE table_schema = DATABASE()\n   AND table_name IN ('credentials', 'users');\n   ```\n   - Documentar aumento de tamanho (esperado 10-20%)\n   - Validar que benefício de performance justifica espaço adicional",
        "status": "pending",
        "dependencies": [
          "1",
          "4",
          "12"
        ],
        "priority": "medium",
        "subtasks": [
          {
            "id": 1,
            "title": "Analisar padrões de queries e identificar gargalos de performance",
            "description": "Habilitar query logging, usar Laravel Debugbar e Telescope para identificar queries N+1, filtros frequentes e ordenações que precisam de otimização",
            "dependencies": [],
            "details": "Instalar Laravel Debugbar (composer require barryvdh/laravel-debugbar --dev), habilitar DB::enableQueryLog() temporariamente, analisar queries do CredentialResource e UserResource no Filament, identificar queries com LIKE, WHERE em validity/fscs/created_at, verificar relacionamentos sem eager loading, documentar queries mais lentas (>100ms) e suas frequências de uso no sistema",
            "status": "pending",
            "testStrategy": "Executar suite de testes feature com Debugbar ativo, capturar queries duplicadas (N+1), medir tempo médio de queries principais, criar baseline de performance antes dos índices com queries típicas do dashboard e listagens",
            "parentId": "undefined"
          },
          {
            "id": 2,
            "title": "Criar migration com índices simples e compostos para tabela credentials",
            "description": "Implementar migration adicionando índices em validity, created_at, fscs, user_id, deleted_at e índices compostos para otimizar filtros e ordenações frequentes",
            "dependencies": [
              1
            ],
            "details": "Criar migration 'add_performance_indexes_to_credentials_table' com índices: idx_credentials_validity (WHERE validity), idx_credentials_created_at (ORDER BY), idx_credentials_fscs (filtro/busca), idx_credentials_validity_created (composto para filtro+ordenação), idx_credentials_user_created (auditoria), idx_credentials_deleted_at (soft deletes). Verificar existência de colunas antes de criar índices com Schema::hasColumn(), nomear índices explicitamente para facilitar manutenção",
            "status": "pending",
            "testStrategy": "Executar migration em ambiente de teste com 10k+ registros, verificar criação dos índices com SHOW INDEX FROM credentials, confirmar que método down() remove todos índices corretamente, testar rollback sem erros",
            "parentId": "undefined"
          },
          {
            "id": 3,
            "title": "Criar migration com índices para tabela users e relacionamentos",
            "description": "Implementar índices na tabela users para otimizar consultas por created_at, role e relacionamentos com credentials",
            "dependencies": [
              1
            ],
            "details": "Criar migration 'add_performance_indexes_to_users_table' adicionando: idx_users_created_at (ordenação temporal), idx_users_role_created (composto para filtros por role), verificar se email já possui índice unique antes de adicionar idx_users_email. Considerar índices para campos de model_has_roles se usar Spatie Permission. Implementar método down() completo para reversão",
            "status": "pending",
            "testStrategy": "Verificar schema atual de users com Schema::getColumnListing(), executar migration, confirmar índices com SHOW INDEX FROM users, testar queries de filtro por role + ordenação, medir performance antes/depois em queries do UserResource",
            "parentId": "undefined"
          },
          {
            "id": 4,
            "title": "Otimizar queries do Filament com eager loading e use de índices",
            "description": "Implementar eager loading em CredentialResource e UserResource, adicionar withCount para relacionamentos e otimizar queries customizadas para usar os novos índices",
            "dependencies": [
              2,
              3
            ],
            "details": "Em CredentialResource.php adicionar getEloquentQuery() com ->with(['user', 'creator', 'updater'])->withCount('auditLogs'), implementar scopeActive() e scopeExpiring() no Model Credential usando índices, otimizar queries de filtros do Filament Tables para usar índices compostos, adicionar ->select() específico onde aplicável para reduzir dados carregados, revisar queries em DashboardController para usar índices",
            "status": "pending",
            "testStrategy": "Usar Laravel Debugbar para verificar redução no número de queries (N+1 resolvidos), medir tempo de carregamento de listagens antes/depois, confirmar que queries usam índices com EXPLAIN SELECT, testar com dataset de 10k+ registros",
            "parentId": "undefined"
          },
          {
            "id": 5,
            "title": "Documentar índices criados e realizar testes de performance comparativos",
            "description": "Criar documentação completa dos índices implementados, seu propósito, trade-offs e realizar testes comparativos de performance antes/depois da implementação",
            "dependencies": [
              2,
              3,
              4
            ],
            "details": "Criar arquivo docs/database_indexes.md documentando: cada índice criado e seu propósito específico, queries beneficiadas por cada índice com exemplos, impacto em operações INSERT/UPDATE/DELETE, tamanho dos índices (SHOW INDEX), guidelines para manutenção futura. Executar script de benchmark comparando tempos de queries principais antes/depois dos índices, documentar ganhos percentuais, incluir considerações sobre FULLTEXT indexes para buscas textuais futuras e particionamento para volumes >1M registros",
            "status": "pending",
            "testStrategy": "Criar PerformanceTestSeeder com 10k registros, executar queries benchmark ANTES das migrations (baseline), aplicar migrations com índices, executar mesmas queries e comparar tempo (esperado: redução >50% em queries com WHERE/ORDER BY), verificar impacto em INSERT com 1000 inserções sequenciais (aceitável: aumento <20%)",
            "parentId": "undefined"
          }
        ]
      },
      {
        "id": 15,
        "title": "Expandir Campos de Controle na Tabela Credentials",
        "description": "Adicionar campos de auditoria básica na tabela credentials (access_count, last_accessed_at, last_accessed_by, edit_count, last_edited_by) e implementar observers do Laravel para atualizar automaticamente esses campos em operações de visualização e edição.",
        "details": "1. **Criar Migration para Campos de Auditoria**:\n   ```bash\n   php artisan make:migration add_audit_fields_to_credentials_table\n   ```\n   ```php\n   public function up() {\n       Schema::table('credentials', function (Blueprint $table) {\n           $table->unsignedInteger('access_count')->default(0)->after('updated_at');\n           $table->timestamp('last_accessed_at')->nullable()->after('access_count');\n           $table->foreignId('last_accessed_by')->nullable()->after('last_accessed_at')->constrained('users')->nullOnDelete();\n           $table->unsignedInteger('edit_count')->default(0)->after('last_accessed_by');\n           $table->foreignId('last_edited_by')->nullable()->after('edit_count')->constrained('users')->nullOnDelete();\n           \n           $table->index('last_accessed_at');\n           $table->index('last_accessed_by');\n           $table->index('last_edited_by');\n       });\n   }\n   ```\n\n2. **Atualizar Model Credential**:\n   ```php\n   // app/Models/Credential.php\n   protected $fillable = [\n       // ... campos existentes\n       'access_count',\n       'last_accessed_at',\n       'last_accessed_by',\n       'edit_count',\n       'last_edited_by',\n   ];\n\n   protected $casts = [\n       'last_accessed_at' => 'datetime',\n       // ... outros casts\n   ];\n\n   public function lastAccessedByUser() {\n       return $this->belongsTo(User::class, 'last_accessed_by');\n   }\n\n   public function lastEditedByUser() {\n       return $this->belongsTo(User::class, 'last_edited_by');\n   }\n   ```\n\n3. **Criar Observer para Credential**:\n   ```bash\n   php artisan make:observer CredentialObserver --model=Credential\n   ```\n   ```php\n   // app/Observers/CredentialObserver.php\n   namespace App\\Observers;\n\n   use App\\Models\\Credential;\n   use Illuminate\\Support\\Facades\\Auth;\n\n   class CredentialObserver\n   {\n       public function updating(Credential $credential)\n       {\n           if ($credential->isDirty() && !$credential->isDirty(['access_count', 'last_accessed_at', 'last_accessed_by'])) {\n               $credential->edit_count = ($credential->edit_count ?? 0) + 1;\n               $credential->last_edited_by = Auth::id();\n           }\n       }\n\n       public function retrieved(Credential $credential)\n       {\n           // Incrementar contador de acesso apenas em contextos de visualização\n           // Evitar incrementar em listagens usando flag de contexto\n           if (request()->route() && request()->route()->getName() === 'credentials.show') {\n               $credential->incrementAccessCount();\n           }\n       }\n   }\n   ```\n\n4. **Adicionar Método Helper no Model**:\n   ```php\n   // app/Models/Credential.php\n   public function incrementAccessCount()\n   {\n       $this->timestamps = false;\n       $this->increment('access_count');\n       $this->update([\n           'last_accessed_at' => now(),\n           'last_accessed_by' => Auth::id(),\n       ]);\n       $this->timestamps = true;\n   }\n   ```\n\n5. **Registrar Observer no AppServiceProvider**:\n   ```php\n   // app/Providers/AppServiceProvider.php\n   use App\\Models\\Credential;\n   use App\\Observers\\CredentialObserver;\n\n   public function boot()\n   {\n       Credential::observe(CredentialObserver::class);\n   }\n   ```\n\n6. **Atualizar CredentialResource do Filament**:\n   ```php\n   // app/Filament/Resources/Credentials/CredentialResource.php\n   public static function form(Form $form): Form\n   {\n       return $form->schema([\n           // ... campos existentes\n           Section::make('Informações de Auditoria')\n               ->schema([\n                   TextInput::make('access_count')\n                       ->label('Número de Acessos')\n                       ->disabled()\n                       ->dehydrated(false),\n                   DateTimePicker::make('last_accessed_at')\n                       ->label('Último Acesso em')\n                       ->disabled()\n                       ->dehydrated(false),\n                   Select::make('last_accessed_by')\n                       ->label('Último Acesso por')\n                       ->relationship('lastAccessedByUser', 'name')\n                       ->disabled()\n                       ->dehydrated(false),\n                   TextInput::make('edit_count')\n                       ->label('Número de Edições')\n                       ->disabled()\n                       ->dehydrated(false),\n                   Select::make('last_edited_by')\n                       ->label('Última Edição por')\n                       ->relationship('lastEditedByUser', 'name')\n                       ->disabled()\n                       ->dehydrated(false),\n               ])\n               ->columns(2)\n               ->collapsible(),\n       ]);\n   }\n\n   public static function table(Table $table): Table\n   {\n       return $table->columns([\n           // ... colunas existentes\n           TextColumn::make('access_count')\n               ->label('Acessos')\n               ->sortable()\n               ->toggleable(isToggledHiddenByDefault: true),\n           TextColumn::make('last_accessed_at')\n               ->label('Último Acesso')\n               ->dateTime('d/m/Y H:i')\n               ->sortable()\n               ->toggleable(isToggledHiddenByDefault: true),\n           TextColumn::make('lastAccessedByUser.name')\n               ->label('Acessado por')\n               ->sortable()\n               ->toggleable(isToggledHiddenByDefault: true),\n       ]);\n   }\n   ```\n\n7. **Criar Controller Method para Rastreamento de Visualização** (se usando rotas customizadas):\n   ```php\n   // app/Http/Controllers/CredentialController.php\n   public function show(Credential $credential)\n   {\n       $credential->incrementAccessCount();\n       return view('credentials.show', compact('credential'));\n   }\n   ```\n\n8. **Considerações Importantes**:\n   - O observer `retrieved` pode gerar overhead; considere usar apenas em rotas específicas de visualização\n   - Desabilitar timestamps temporariamente ao incrementar access_count evita atualizar updated_at\n   - Adicionar índices nos campos de foreign key para performance\n   - Considerar usar eventos customizados (CredentialViewed, CredentialEdited) para melhor controle\n   - Integrar com Task 13 (Audit Logs) para auditoria completa se necessário",
        "testStrategy": "1. **Testes de Migration**:\n   ```bash\n   php artisan migrate:fresh --seed\n   ```\n   - Verificar que tabela credentials possui novos campos: access_count, last_accessed_at, last_accessed_by, edit_count, last_edited_by\n   - Confirmar que índices foram criados corretamente\n\n2. **Testes Unitários do Observer**:\n   ```php\n   // tests/Unit/CredentialObserverTest.php\n   test('incrementa edit_count ao atualizar credential', function () {\n       $user = User::factory()->create();\n       $this->actingAs($user);\n       $credential = Credential::factory()->create(['edit_count' => 0]);\n       \n       $credential->update(['title' => 'Novo Título']);\n       \n       expect($credential->fresh()->edit_count)->toBe(1)\n           ->and($credential->fresh()->last_edited_by)->toBe($user->id);\n   });\n\n   test('não incrementa edit_count ao atualizar apenas campos de auditoria', function () {\n       $credential = Credential::factory()->create(['edit_count' => 5]);\n       \n       $credential->incrementAccessCount();\n       \n       expect($credential->fresh()->edit_count)->toBe(5);\n   });\n\n   test('incrementa access_count corretamente', function () {\n       $user = User::factory()->create();\n       $this->actingAs($user);\n       $credential = Credential::factory()->create(['access_count' => 0]);\n       \n       $credential->incrementAccessCount();\n       \n       expect($credential->fresh()->access_count)->toBe(1)\n           ->and($credential->fresh()->last_accessed_at)->not->toBeNull()\n           ->and($credential->fresh()->last_accessed_by)->toBe($user->id);\n   });\n   ```\n\n3. **Testes de Feature**:\n   ```php\n   // tests/Feature/CredentialAuditTest.php\n   test('visualizar credential incrementa contador de acesso', function () {\n       $user = User::factory()->create();\n       $credential = Credential::factory()->create(['access_count' => 0]);\n       \n       $this->actingAs($user)\n           ->get(route('credentials.show', $credential))\n           ->assertOk();\n       \n       expect($credential->fresh()->access_count)->toBe(1);\n   });\n\n   test('editar credential incrementa contador de edição', function () {\n       $user = User::factory()->create();\n       $credential = Credential::factory()->create(['edit_count' => 0]);\n       \n       $this->actingAs($user)\n           ->put(route('credentials.update', $credential), [\n               'title' => 'Título Atualizado',\n               'username' => $credential->username,\n           ]);\n       \n       expect($credential->fresh()->edit_count)->toBe(1)\n           ->and($credential->fresh()->last_edited_by)->toBe($user->id);\n   });\n   ```\n\n4. **Testes de Interface Filament**:\n   - Acessar painel /admin/credentials e verificar que colunas de auditoria aparecem (mesmo que ocultas por padrão)\n   - Editar uma credential e confirmar que edit_count incrementa\n   - Visualizar detalhes e confirmar que access_count incrementa\n   - Verificar que seção \"Informações de Auditoria\" aparece no formulário de edição\n\n5. **Testes de Performance**:\n   ```bash\n   php artisan db:seed --class=PerformanceTestSeeder # 1000+ registros\n   ```\n   - Executar queries de listagem e verificar que índices estão sendo utilizados\n   - Confirmar que operação incrementAccessCount não causa N+1 queries\n   - Verificar que updated_at não é modificado ao incrementar access_count\n\n6. **Teste de Relacionamentos**:\n   - Verificar que $credential->lastAccessedByUser retorna instância de User\n   - Verificar que $credential->lastEditedByUser retorna instância de User\n   - Testar comportamento quando usuário é deletado (nullOnDelete)",
        "status": "pending",
        "dependencies": [
          "12",
          "14"
        ],
        "priority": "medium",
        "subtasks": [
          {
            "id": 1,
            "title": "Criar migration para adicionar campos de auditoria na tabela credentials",
            "description": "Criar migration add_audit_fields_to_credentials_table que adiciona os campos access_count, last_accessed_at, last_accessed_by, edit_count e last_edited_by à tabela credentials com índices apropriados.",
            "dependencies": [],
            "details": "Executar `php artisan make:migration add_audit_fields_to_credentials_table` e implementar o método up() adicionando: access_count (unsignedInteger, default 0), last_accessed_at (timestamp nullable), last_accessed_by (foreignId nullable com constraint para users), edit_count (unsignedInteger, default 0), last_edited_by (foreignId nullable com constraint para users). Adicionar índices em last_accessed_at, last_accessed_by e last_edited_by para otimizar consultas. O método down() deve remover esses campos na ordem inversa.",
            "status": "pending",
            "testStrategy": "Executar `php artisan migrate` e verificar com `php artisan migrate:status` que a migration foi aplicada. Usar `DESCRIBE credentials;` no MySQL para confirmar que os campos foram criados com tipos corretos. Verificar índices com `SHOW INDEX FROM credentials;`. Testar rollback com `php artisan migrate:rollback` e confirmar que campos foram removidos.",
            "parentId": "undefined"
          },
          {
            "id": 2,
            "title": "Atualizar Model Credential com campos e relacionamentos de auditoria",
            "description": "Adicionar campos de auditoria ao $fillable, criar casts para last_accessed_at e definir relacionamentos lastAccessedByUser() e lastEditedByUser() no Model Credential.",
            "dependencies": [
              1
            ],
            "details": "Em app/Models/Credential.php, adicionar 'access_count', 'last_accessed_at', 'last_accessed_by', 'edit_count', 'last_edited_by' ao array $fillable. No array $casts, adicionar 'last_accessed_at' => 'datetime'. Criar métodos de relacionamento: lastAccessedByUser() retornando $this->belongsTo(User::class, 'last_accessed_by') e lastEditedByUser() retornando $this->belongsTo(User::class, 'last_edited_by'). Adicionar método helper incrementAccessCount() que desabilita timestamps, incrementa access_count e atualiza last_accessed_at e last_accessed_by com Auth::id().",
            "status": "pending",
            "testStrategy": "Criar teste unitário que instancia Credential e verifica que relacionamentos lastAccessedByUser e lastEditedByUser retornam instâncias de User quando IDs válidos são definidos. Testar método incrementAccessCount() verificando que access_count incrementa, last_accessed_at é atualizado e updated_at não muda. Usar factory para criar credentials de teste e verificar que casts funcionam corretamente.",
            "parentId": "undefined"
          },
          {
            "id": 3,
            "title": "Criar CredentialObserver para rastreamento automático de acessos e edições",
            "description": "Implementar observer que captura eventos retrieved e updating do Model Credential para incrementar contadores de acesso e edição automaticamente.",
            "dependencies": [
              2
            ],
            "details": "Executar `php artisan make:observer CredentialObserver --model=Credential`. Em app/Observers/CredentialObserver.php, implementar método updating() que verifica se o model tem mudanças excluindo campos de auditoria usando isDirty(), incrementa edit_count e define last_edited_by com Auth::id(). Implementar método retrieved() que verifica se a rota é 'credentials.show' ou contexto Filament de visualização antes de chamar incrementAccessCount(). Usar condicionais para evitar incrementar em listagens ou operações em massa.",
            "status": "pending",
            "testStrategy": "Criar teste de feature que simula visualização de credential via Filament e verifica que access_count incrementa e last_accessed_at é atualizado. Testar que listagens não incrementam access_count. Criar teste que atualiza campos de credential e verifica que edit_count incrementa e last_edited_by é definido corretamente. Verificar que atualizações apenas em campos de auditoria não incrementam edit_count.",
            "parentId": "undefined"
          },
          {
            "id": 4,
            "title": "Registrar CredentialObserver no AppServiceProvider",
            "description": "Adicionar registro do CredentialObserver no método boot() do AppServiceProvider para ativar os eventos de auditoria.",
            "dependencies": [
              3
            ],
            "details": "Em app/Providers/AppServiceProvider.php, importar use App\\Models\\Credential e use App\\Observers\\CredentialObserver no topo do arquivo. No método boot(), adicionar Credential::observe(CredentialObserver::class) para registrar o observer. Verificar que não há conflitos com outros observers já registrados. Se AppServiceProvider estiver muito carregado, considerar criar EventServiceProvider dedicado.",
            "status": "pending",
            "testStrategy": "Executar `php artisan tinker` e testar manualmente: criar credential, atualizá-la e verificar que edit_count incrementa. Usar teste de integração que cria e atualiza credential via Eloquent verificando que observers são disparados. Executar `php artisan about` para confirmar que provider está registrado corretamente. Verificar logs de aplicação para confirmar ausência de erros de observer.",
            "parentId": "undefined"
          },
          {
            "id": 5,
            "title": "Atualizar CredentialResource do Filament com campos de auditoria",
            "description": "Adicionar seção de Informações de Auditoria no formulário e colunas toggleable na tabela do CredentialResource para exibir dados de acesso e edição.",
            "dependencies": [
              2
            ],
            "details": "Em app/Filament/Resources/Credentials/CredentialResource.php, adicionar Section 'Informações de Auditoria' no form() com campos disabled: TextInput para access_count e edit_count, DateTimePicker para last_accessed_at, Select com relationship para last_accessed_by e last_edited_by apontando para lastAccessedByUser e lastEditedByUser. Marcar todos com dehydrated(false). Na table(), adicionar TextColumn para access_count, last_accessed_at (formato 'd/m/Y H:i') e lastAccessedByUser.name, todos com sortable() e toggleable(isToggledHiddenByDefault: true). Configurar seção como collapsible() e columns(2).",
            "status": "pending",
            "testStrategy": "Acessar painel Filament e navegar para recurso Credentials. Verificar que seção de auditoria aparece no formulário de edição com campos desabilitados exibindo valores corretos. Testar que campos não são enviados no submit (dehydrated false). Na tabela, verificar que colunas de auditoria estão ocultas por padrão e podem ser ativadas via toggle. Testar ordenação por access_count e last_accessed_at. Criar credential, visualizá-la e editar, depois verificar que valores de auditoria são exibidos corretamente.",
            "parentId": "undefined"
          }
        ]
      },
      {
        "id": 16,
        "title": "Corrigir Tipagem do Campo Secrecy de VARCHAR para ENUM",
        "description": "Alterar o campo secrecy na tabela credentials de VARCHAR para ENUM('R','S') para garantir consistência dos dados, onde R=Reservado e S=Secreto, incluindo migration, atualização de validações no Filament e ajustes no Model.",
        "details": "1. **Criar Migration para Alteração do Campo**:\n   ```bash\n   php artisan make:migration change_secrecy_column_to_enum_in_credentials_table\n   ```\n   ```php\n   use Illuminate\\Database\\Migrations\\Migration;\n   use Illuminate\\Database\\Schema\\Blueprint;\n   use Illuminate\\Support\\Facades\\Schema;\n   use Illuminate\\Support\\Facades\\DB;\n\n   public function up() {\n       // Laravel não suporta alteração direta para ENUM com change()\n       // Necessário usar DB::statement para MySQL\n       DB::statement(\"ALTER TABLE credentials MODIFY COLUMN secrecy ENUM('R', 'S') NOT NULL\");\n   }\n\n   public function down() {\n       DB::statement(\"ALTER TABLE credentials MODIFY COLUMN secrecy VARCHAR(255) NOT NULL\");\n   }\n   ```\n\n2. **Atualizar Model Credential**:\n   ```php\n   // app/Models/Credential.php\n   class Credential extends Model {\n       protected $fillable = [\n           'secrecy',\n           // ... outros campos\n       ];\n\n       // Adicionar accessor para labels legíveis\n       public function getSecrecyLabelAttribute(): string {\n           return match($this->secrecy) {\n               'R' => 'Reservado',\n               'S' => 'Secreto',\n               default => $this->secrecy\n           };\n       }\n\n       // Adicionar constantes para valores permitidos\n       const SECRECY_RESERVADO = 'R';\n       const SECRECY_SECRETO = 'S';\n\n       public static function getSecrecyOptions(): array {\n           return [\n               self::SECRECY_RESERVADO => 'Reservado',\n               self::SECRECY_SECRETO => 'Secreto',\n           ];\n       }\n   }\n   ```\n\n3. **Atualizar CredentialResource do Filament**:\n   ```php\n   // app/Filament/Resources/Credentials/CredentialResource.php\n   use Filament\\Forms\\Components\\Select;\n   use Filament\\Tables\\Columns\\TextColumn;\n\n   public static function form(Form $form): Form {\n       return $form->schema([\n           Select::make('secrecy')\n               ->label('Grau de Sigilo')\n               ->options([\n                   'R' => 'Reservado',\n                   'S' => 'Secreto',\n               ])\n               ->required()\n               ->native(false)\n               ->default('R')\n               ->helperText('R = Reservado, S = Secreto'),\n           // ... outros campos\n       ]);\n   }\n\n   public static function table(Table $table): Table {\n       return $table->columns([\n           TextColumn::make('secrecy')\n               ->label('Sigilo')\n               ->badge()\n               ->color(fn (string $state): string => match ($state) {\n                   'R' => 'warning',\n                   'S' => 'danger',\n               })\n               ->formatStateUsing(fn (string $state): string => match ($state) {\n                   'R' => 'Reservado',\n                   'S' => 'Secreto',\n                   default => $state\n               })\n               ->sortable()\n               ->searchable(),\n           // ... outras colunas\n       ]);\n   }\n   ```\n\n4. **Atualizar Validações no Controller (se existir)**:\n   ```php\n   // app/Http/Controllers/CredentialController.php\n   public function store(Request $request) {\n       $validated = $request->validate([\n           'secrecy' => ['required', 'string', Rule::in(['R', 'S'])],\n           // ... outras validações\n       ]);\n   }\n   ```\n\n5. **Criar Seeder para Normalizar Dados Existentes** (se necessário):\n   ```php\n   // database/seeders/NormalizeSecrecySeeder.php\n   public function run() {\n       // Converter valores antigos para novo formato\n       DB::table('credentials')\n           ->where('secrecy', 'Reservado')\n           ->orWhere('secrecy', 'reservado')\n           ->update(['secrecy' => 'R']);\n\n       DB::table('credentials')\n           ->where('secrecy', 'Secreto')\n           ->orWhere('secrecy', 'secreto')\n           ->update(['secrecy' => 'S']);\n   }\n   ```\n\n6. **Atualizar Filtros do Filament** (se implementado na Task 6):\n   ```php\n   use Filament\\Tables\\Filters\\SelectFilter;\n\n   public static function table(Table $table): Table {\n       return $table\n           ->filters([\n               SelectFilter::make('secrecy')\n                   ->label('Grau de Sigilo')\n                   ->options([\n                       'R' => 'Reservado',\n                       'S' => 'Secreto',\n                   ])\n                   ->multiple(),\n           ]);\n   }\n   ```",
        "testStrategy": "1. **Testes de Migration**:\n   ```bash\n   # Backup do banco antes de executar\n   php artisan migrate\n   ```\n   - Verificar estrutura da tabela: `DESCRIBE credentials;` deve mostrar secrecy como enum('R','S')\n   - Tentar inserir valor inválido via SQL e confirmar erro: `INSERT INTO credentials (secrecy) VALUES ('X');` deve falhar\n\n2. **Testes de Validação no Filament**:\n   - Acessar formulário de criação de credencial\n   - Verificar que campo secrecy exibe apenas opções 'Reservado' e 'Secreto'\n   - Confirmar que valor padrão é 'R' (Reservado)\n   - Verificar helper text exibindo 'R = Reservado, S = Secreto'\n\n3. **Testes de Listagem e Filtros**:\n   - Na tabela de credentials, verificar coluna Sigilo exibe badges coloridos\n   - Verificar cor warning para Reservado e danger para Secreto\n   - Testar filtro de Grau de Sigilo filtrando por R e S\n   - Confirmar que busca e ordenação funcionam corretamente\n\n4. **Testes Unitários com Pest**:\n   ```php\n   test('secrecy aceita apenas R ou S', function () {\n       $credential = Credential::factory()->create(['secrecy' => 'R']);\n       expect($credential->secrecy)->toBe('R');\n\n       $credential->secrecy = 'S';\n       $credential->save();\n       expect($credential->fresh()->secrecy)->toBe('S');\n   });\n\n   test('getSecrecyOptions retorna array correto', function () {\n       $options = Credential::getSecrecyOptions();\n       expect($options)->toHaveKeys(['R', 'S'])\n           ->and($options['R'])->toBe('Reservado')\n           ->and($options['S'])->toBe('Secreto');\n   });\n\n   test('secrecy label retorna texto legível', function () {\n       $credential = Credential::factory()->create(['secrecy' => 'R']);\n       expect($credential->secrecy_label)->toBe('Reservado');\n   });\n   ```\n\n5. **Teste de Integridade de Dados**:\n   - Executar seeder de normalização se houver dados antigos\n   - Confirmar que todos os registros têm secrecy = 'R' ou 'S'\n   - Verificar query: `SELECT DISTINCT secrecy FROM credentials;` retorna apenas 'R' e 'S'\n\n6. **Teste de Rollback**:\n   ```bash\n   php artisan migrate:rollback --step=1\n   ```\n   - Verificar que campo retorna para VARCHAR\n   - Executar migration novamente e confirmar sucesso",
        "status": "pending",
        "dependencies": [
          "1",
          "11",
          "12"
        ],
        "priority": "medium",
        "subtasks": [
          {
            "id": 1,
            "title": "Criar migration para alterar campo secrecy de VARCHAR para ENUM",
            "description": "Criar migration que utiliza DB::statement para alterar o campo secrecy de VARCHAR para ENUM('R','S') na tabela credentials, incluindo método down para rollback.",
            "dependencies": [],
            "details": "Executar 'php artisan make:migration change_secrecy_column_to_enum_in_credentials_table'. Implementar método up() com DB::statement(\"ALTER TABLE credentials MODIFY COLUMN secrecy ENUM('R', 'S') NOT NULL\") e método down() com DB::statement(\"ALTER TABLE credentials MODIFY COLUMN secrecy VARCHAR(255) NOT NULL\"). Verificar arquivos de migration existentes para manter padrão do projeto.",
            "status": "pending",
            "testStrategy": "Executar migration com 'php artisan migrate' e verificar estrutura com 'DESCRIBE credentials'. Testar rollback com 'php artisan migrate:rollback' e confirmar retorno ao VARCHAR. Verificar que dados existentes são preservados durante alteração.",
            "parentId": "undefined"
          },
          {
            "id": 2,
            "title": "Criar seeder para normalizar dados existentes do campo secrecy",
            "description": "Implementar seeder que converte valores VARCHAR existentes ('Reservado', 'Secreto') para formato ENUM ('R', 'S') antes da alteração do schema.",
            "dependencies": [],
            "details": "Criar 'database/seeders/NormalizeSecrecySeeder.php' com lógica para converter valores: 'Reservado'/'reservado' -> 'R' e 'Secreto'/'secreto' -> 'S' usando DB::table('credentials')->update(). Este seeder deve ser executado ANTES da migration de alteração do campo para evitar erros de conversão de tipo.",
            "status": "pending",
            "testStrategy": "Executar seeder com 'php artisan db:seed --class=NormalizeSecrecySeeder' e verificar com query SQL que todos registros foram convertidos corretamente. Confirmar que não existem valores diferentes de 'R' ou 'S' após execução.",
            "parentId": "undefined"
          },
          {
            "id": 3,
            "title": "Atualizar Model Credential com constantes e métodos para ENUM secrecy",
            "description": "Adicionar constantes SECRECY_RESERVADO e SECRECY_SECRETO, método getSecrecyOptions() e accessor getSecrecyLabelAttribute() no Model Credential.",
            "dependencies": [
              1
            ],
            "details": "Em 'app/Models/Credential.php', adicionar: const SECRECY_RESERVADO = 'R'; const SECRECY_SECRETO = 'S'; método estático getSecrecyOptions() retornando array ['R' => 'Reservado', 'S' => 'Secreto']; accessor getSecrecyLabelAttribute() usando match expression para retornar labels legíveis. Verificar implementação atual do Model para manter padrões existentes.",
            "status": "pending",
            "testStrategy": "Criar teste unitário verificando que Credential::getSecrecyOptions() retorna array correto. Testar accessor com $credential->secrecy_label retornando 'Reservado' para 'R' e 'Secreto' para 'S'. Verificar que constantes estão acessíveis via Credential::SECRECY_RESERVADO.",
            "parentId": "undefined"
          },
          {
            "id": 4,
            "title": "Atualizar CredentialResource do Filament com Select e badges para secrecy",
            "description": "Modificar form() e table() do CredentialResource para usar Select com opções ENUM e TextColumn com badges coloridos para exibição do campo secrecy.",
            "dependencies": [
              3
            ],
            "details": "Em 'app/Filament/Resources/Credentials/CredentialResource.php', atualizar form() com Select::make('secrecy')->options(['R' => 'Reservado', 'S' => 'Secreto'])->required()->native(false)->default('R'). No table(), configurar TextColumn::make('secrecy')->badge()->color(fn => match)->formatStateUsing(fn => match) para exibir 'Reservado' (warning) e 'Secreto' (danger). Verificar arquivo atual para manter padrões de UI.",
            "status": "pending",
            "testStrategy": "Testar interface do Filament criando e editando credencial, verificando que Select exibe opções corretas. Confirmar que tabela exibe badges coloridos: amarelo para Reservado, vermelho para Secreto. Verificar que campo é obrigatório e não aceita valores vazios.",
            "parentId": "undefined"
          },
          {
            "id": 5,
            "title": "Atualizar validações de secrecy em Controllers e FormRequests",
            "description": "Adicionar Rule::in(['R', 'S']) nas validações de secrecy em todos controllers e form requests relacionados a Credential.",
            "dependencies": [
              3
            ],
            "details": "Verificar existência de 'app/Http/Controllers/CredentialController.php' e FormRequests. Atualizar regras de validação para 'secrecy' => ['required', 'string', Rule::in(['R', 'S'])]. Usar Grep para localizar todas validações de 'secrecy' no projeto e garantir consistência. Se projeto usa apenas Filament, validação pode estar concentrada no Resource.",
            "status": "pending",
            "testStrategy": "Criar teste funcional tentando enviar valores inválidos para secrecy ('X', 'invalido', null) e verificar que validação retorna erro. Testar que valores 'R' e 'S' são aceitos corretamente. Verificar mensagens de erro de validação em português.",
            "parentId": "undefined"
          }
        ]
      },
      {
        "id": 17,
        "title": "Refatorar Estrutura de Filament Resources e Implementar Policies",
        "description": "Reorganizar arquitetura do Filament extraindo Schemas e Tables para arquivos separados, implementar Laravel Policies para substituir autorização inline, configurar Filament Shield e remover código duplicado/obsoleto.",
        "details": "1. **Extrair Schemas para Arquivos Separados**:\n   ```bash\n   # Criar estrutura de diretórios\n   mkdir -p app/Filament/Resources/UserResource/Schemas\n   mkdir -p app/Filament/Resources/UserResource/Tables\n   ```\n   \n   Criar `app/Filament/Resources/UserResource/Schemas/UserForm.php`:\n   ```php\n   <?php\n   namespace App\\Filament\\Resources\\UserResource\\Schemas;\n   \n   use Filament\\Schemas\\Schema;\n   use Filament\\Schemas\\Components\\Section;\n   use Filament\\Schemas\\Components\\TextInput;\n   use Filament\\Schemas\\Components\\Select;\n   \n   class UserForm\n   {\n       public static function schema(): array\n       {\n           return [\n               Section::make('Informações do Usuário')\n                   ->schema([\n                       TextInput::make('name')->required()->maxLength(255),\n                       TextInput::make('email')->email()->required()->unique(ignoreRecord: true),\n                       TextInput::make('password')->password()->required(fn ($context) => $context === 'create'),\n                       Select::make('roles')->relationship('roles', 'name')->multiple()->preload(),\n                   ])\n                   ->columns(2),\n           ];\n       }\n   }\n   ```\n   \n   Criar `app/Filament/Resources/UserResource/Tables/UsersTable.php`:\n   ```php\n   <?php\n   namespace App\\Filament\\Resources\\UserResource\\Tables;\n   \n   use Filament\\Tables\\Table;\n   use Filament\\Tables\\Columns\\TextColumn;\n   use Filament\\Tables\\Filters\\SelectFilter;\n   use Filament\\Actions\\EditAction;\n   use Filament\\Actions\\DeleteAction;\n   \n   class UsersTable\n   {\n       public static function table(Table $table): Table\n       {\n           return $table\n               ->columns([\n                   TextColumn::make('name')->searchable()->sortable(),\n                   TextColumn::make('email')->searchable(),\n                   TextColumn::make('roles.name')->badge(),\n                   TextColumn::make('created_at')->dateTime('d/m/Y H:i'),\n               ])\n               ->filters([\n                   SelectFilter::make('role')->relationship('roles', 'name'),\n               ])\n               ->actions([\n                   EditAction::make(),\n                   DeleteAction::make(),\n               ]);\n       }\n   }\n   ```\n   \n   Atualizar `app/Filament/Resources/UserResource.php` para usar schemas separados:\n   ```php\n   use App\\Filament\\Resources\\UserResource\\Schemas\\UserForm;\n   use App\\Filament\\Resources\\UserResource\\Tables\\UsersTable;\n   \n   public static function form(Schema $schema): Schema\n   {\n       return $schema->components(UserForm::schema());\n   }\n   \n   public static function table(Table $table): Table\n   {\n       return UsersTable::table($table);\n   }\n   ```\n\n2. **Implementar Laravel Policies**:\n   ```bash\n   php artisan make:policy CredentialPolicy --model=Credential\n   php artisan make:policy UserPolicy --model=User\n   ```\n   \n   `app/Policies/CredentialPolicy.php`:\n   ```php\n   <?php\n   namespace App\\Policies;\n   \n   use App\\Models\\User;\n   use App\\Models\\Credential;\n   \n   class CredentialPolicy\n   {\n       public function viewAny(User $user): bool\n       {\n           return $user->hasRole(['super_admin', 'admin', 'consulta', 'operador']);\n       }\n       \n       public function view(User $user, Credential $credential): bool\n       {\n           return $user->hasRole(['super_admin', 'admin', 'consulta', 'operador']);\n       }\n       \n       public function create(User $user): bool\n       {\n           return $user->hasRole(['super_admin', 'admin', 'operador']);\n       }\n       \n       public function update(User $user, Credential $credential): bool\n       {\n           return $user->hasRole(['super_admin', 'admin', 'operador']);\n       }\n       \n       public function delete(User $user, Credential $credential): bool\n       {\n           return $user->hasRole(['super_admin', 'admin']);\n       }\n       \n       public function restore(User $user, Credential $credential): bool\n       {\n           return $user->hasRole(['super_admin', 'admin']);\n       }\n       \n       public function forceDelete(User $user, Credential $credential): bool\n       {\n           return $user->hasRole(['super_admin']);\n       }\n   }\n   ```\n   \n   `app/Policies/UserPolicy.php`:\n   ```php\n   <?php\n   namespace App\\Policies;\n   \n   use App\\Models\\User;\n   \n   class UserPolicy\n   {\n       public function viewAny(User $user): bool\n       {\n           return $user->hasRole(['super_admin', 'admin', 'consulta']);\n       }\n       \n       public function view(User $user, User $model): bool\n       {\n           return $user->hasRole(['super_admin', 'admin', 'consulta']);\n       }\n       \n       public function create(User $user): bool\n       {\n           return $user->hasRole(['super_admin', 'admin']);\n       }\n       \n       public function update(User $user, User $model): bool\n       {\n           return $user->hasRole(['super_admin', 'admin']);\n       }\n       \n       public function delete(User $user, User $model): bool\n       {\n           if ($model->email === 'admin@admin.com') {\n               return false;\n           }\n           return $user->hasRole(['super_admin', 'admin']);\n       }\n   }\n   ```\n   \n   Registrar Policies em `app/Providers/AuthServiceProvider.php`:\n   ```php\n   protected $policies = [\n       Credential::class => CredentialPolicy::class,\n       User::class => UserPolicy::class,\n   ];\n   ```\n\n3. **Atualizar Resources para Usar Policies**:\n   \n   Remover métodos `canAccess()`, `canCreate()`, etc. de `CredentialResource.php` e `UserResource.php`, pois Filament automaticamente usará as Policies registradas.\n\n4. **Configurar Filament Shield**:\n   ```bash\n   composer require bezhansalleh/filament-shield\n   php artisan vendor:publish --tag=filament-shield-config\n   php artisan shield:install\n   php artisan shield:generate --all\n   ```\n   \n   Adicionar Shield ao AdminPanelProvider:\n   ```php\n   use BezhanSalleh\\FilamentShield\\FilamentShieldPlugin;\n   \n   public function panel(Panel $panel): Panel\n   {\n       return $panel\n           ->plugins([\n               FilamentShieldPlugin::make(),\n           ]);\n   }\n   ```\n\n5. **Deletar Código Duplicado e Obsoleto**:\n   ```bash\n   # Remover estruturas antigas duplicadas\n   rm -rf app/Filament/Resources/Users/\n   rm -rf app/Http/Livewire/\n   \n   # Verificar se há controllers antigos não utilizados\n   ls app/Http/Controllers/\n   # Deletar controllers que foram substituídos por Filament Resources\n   ```\n   \n   Verificar e remover no `web.php` rotas antigas que não são mais necessárias:\n   ```php\n   // Manter apenas rotas essenciais como login-admin\n   ```\n\n6. **Executar Limpeza de Cache e Otimizações**:\n   ```bash\n   vendor/bin/sail artisan optimize:clear\n   vendor/bin/sail artisan config:cache\n   vendor/bin/sail artisan route:cache\n   vendor/bin/sail bin pint --dirty\n   ```",
        "testStrategy": "1. **Testes de Estrutura de Arquivos**:\n   ```bash\n   # Verificar que arquivos foram criados corretamente\n   ls -la app/Filament/Resources/UserResource/Schemas/UserForm.php\n   ls -la app/Filament/Resources/UserResource/Tables/UsersTable.php\n   ls -la app/Filament/Resources/Credentials/Schemas/CredentialForm.php\n   ls -la app/Filament/Resources/Credentials/Tables/CredentialsTable.php\n   \n   # Verificar que arquivos duplicados foram removidos\n   test ! -d app/Filament/Resources/Users/ && echo \"OK: Diretório Users/ removido\"\n   test ! -d app/Http/Livewire/ && echo \"OK: Diretório Livewire/ removido\"\n   ```\n\n2. **Testes de Policies**:\n   ```bash\n   vendor/bin/sail artisan test --filter=PolicyTest\n   ```\n   \n   Criar `tests/Feature/CredentialPolicyTest.php`:\n   ```php\n   test('super_admin pode criar credencial', function () {\n       $user = User::factory()->create();\n       $user->assignRole('super_admin');\n       $this->actingAs($user);\n       \n       $this->assertTrue($user->can('create', Credential::class));\n   });\n   \n   test('consulta não pode criar credencial', function () {\n       $user = User::factory()->create();\n       $user->assignRole('consulta');\n       $this->actingAs($user);\n       \n       $this->assertFalse($user->can('create', Credential::class));\n   });\n   \n   test('admin pode deletar credencial', function () {\n       $user = User::factory()->create();\n       $user->assignRole('admin');\n       $credential = Credential::factory()->create();\n       $this->actingAs($user);\n       \n       $this->assertTrue($user->can('delete', $credential));\n   });\n   ```\n\n3. **Testes de Integração com Filament**:\n   ```bash\n   # Acessar painel como super_admin\n   vendor/bin/sail artisan tinker --execute=\"Auth::login(User::where('email', 'admin@admin.com')->first());\"\n   ```\n   - Acessar http://localhost/admin/credentials e verificar que lista carrega\n   - Tentar criar nova credencial e confirmar que form renderiza corretamente\n   - Logar como usuário com role 'consulta' e verificar que botões de criar/editar/deletar estão ocultos\n   - Verificar que ao tentar acessar /admin/credentials/create como 'consulta' retorna 403\n\n4. **Testes de Filament Shield**:\n   ```bash\n   vendor/bin/sail artisan shield:generate --all\n   # Verificar que permissions foram criadas\n   vendor/bin/sail artisan tinker --execute=\"Permission::all()->pluck('name');\"\n   ```\n   - Acessar http://localhost/admin/shield/roles\n   - Verificar que pode editar permissions por role\n   - Atribuir/remover permissions e testar que autorização funciona dinamicamente\n\n5. **Testes de Formatação de Código**:\n   ```bash\n   vendor/bin/sail bin pint --test\n   # Deve passar sem erros\n   ```\n\n6. **Teste de Regressão Completo**:\n   - Login como admin@admin.com\n   - CRUD completo de credenciais: criar, editar, visualizar, deletar\n   - CRUD completo de usuários: criar usuário com role operador, editar, deletar\n   - Verificar que filtros e buscas continuam funcionando\n   - Confirmar que soft delete continua funcionando (credenciais deletadas não aparecem na listagem)\n   - Executar suite completa de testes: `vendor/bin/sail artisan test`",
        "status": "pending",
        "dependencies": [
          11,
          12
        ],
        "priority": "high",
        "subtasks": []
      },
      {
        "id": 18,
        "title": "FASE 2: Models e Eloquent - Adicionar Type Safety e Factories Completas",
        "description": "Modernizar Models com type hints completos (HasMany, BelongsTo), PHPDoc, método casts(), criar factories com states avançados para testes, implementar sistema de auditoria com Observer e externalizar email hardcoded para configuração.",
        "details": "1. **Adicionar Type Hints e PHPDoc nos Models**:\n\n   Atualizar `app/Models/User.php`:\n   ```php\n   use Illuminate\\Database\\Eloquent\\Relations\\HasMany;\n   use Illuminate\\Database\\Eloquent\\Relations\\BelongsToMany;\n   \n   /**\n    * @property int $id\n    * @property string $name\n    * @property string $email\n    * @property \\Illuminate\\Support\\Carbon $created_at\n    * @property \\Illuminate\\Support\\Carbon $updated_at\n    */\n   class User extends Authenticatable\n   {\n       /** @return HasMany<Credential> */\n       public function credentials(): HasMany\n       {\n           return $this->hasMany(Credential::class, 'user_id');\n       }\n       \n       /** @return BelongsToMany<Role> */\n       public function roles(): BelongsToMany\n       {\n           return $this->belongsToMany(Role::class);\n       }\n       \n       protected function casts(): array\n       {\n           return [\n               'email_verified_at' => 'datetime',\n               'password' => 'hashed',\n           ];\n       }\n   }\n   ```\n\n   Atualizar `app/Models/Credential.php`:\n   ```php\n   use Illuminate\\Database\\Eloquent\\Relations\\BelongsTo;\n   \n   /**\n    * @property int $id\n    * @property string $fscs\n    * @property string $name\n    * @property string $secrecy\n    * @property \\Illuminate\\Support\\Carbon $validity\n    * @property int|null $user_id\n    * @property int|null $created_by\n    * @property int|null $updated_by\n    */\n   class Credential extends Model\n   {\n       /** @return BelongsTo<User, Credential> */\n       public function user(): BelongsTo\n       {\n           return $this->belongsTo(User::class);\n       }\n       \n       /** @return BelongsTo<User, Credential> */\n       public function creator(): BelongsTo\n       {\n           return $this->belongsTo(User::class, 'created_by');\n       }\n       \n       /** @return BelongsTo<User, Credential> */\n       public function updater(): BelongsTo\n       {\n           return $this->belongsTo(User::class, 'updated_by');\n       }\n       \n       protected function casts(): array\n       {\n           return [\n               'validity' => 'datetime',\n               'deleted_at' => 'datetime',\n           ];\n       }\n   }\n   ```\n\n   Atualizar `app/Models/Role.php`:\n   ```php\n   /**\n    * @property int $id\n    * @property string $name\n    * @property string $guard_name\n    */\n   class Role extends \\Spatie\\Permission\\Models\\Role\n   {\n       /** @return BelongsToMany<User> */\n       public function users(): BelongsToMany\n       {\n           return $this->belongsToMany(User::class, 'model_has_roles', 'role_id', 'model_id');\n       }\n   }\n   ```\n\n2. **Criar CredentialFactory com States Avançados**:\n\n   ```bash\n   php artisan make:factory CredentialFactory\n   ```\n\n   `database/factories/CredentialFactory.php`:\n   ```php\n   <?php\n   namespace Database\\Factories;\n   \n   use App\\Models\\Credential;\n   use App\\Models\\User;\n   use Illuminate\\Database\\Eloquent\\Factories\\Factory;\n   \n   class CredentialFactory extends Factory\n   {\n       protected $model = Credential::class;\n       \n       public function definition(): array\n       {\n           return [\n               'fscs' => $this->faker->unique()->regexify('[A-Z]{3}[0-9]{4}'),\n               'name' => $this->faker->company() . ' - ' . $this->faker->word(),\n               'secrecy' => $this->faker->randomElement(['R', 'S']),\n               'validity' => $this->faker->dateTimeBetween('+1 month', '+2 years'),\n               'user_id' => User::factory(),\n               'created_by' => User::factory(),\n               'updated_by' => null,\n           ];\n       }\n       \n       /** Credencial já expirada */\n       public function expired(): static\n       {\n           return $this->state(fn (array $attributes) => [\n               'validity' => $this->faker->dateTimeBetween('-1 year', '-1 day'),\n           ]);\n       }\n       \n       /** Credencial expirando nos próximos 30 dias */\n       public function expiringSoon(): static\n       {\n           return $this->state(fn (array $attributes) => [\n               'validity' => $this->faker->dateTimeBetween('now', '+30 days'),\n           ]);\n       }\n       \n       /** Credencial com nível Secreto */\n       public function secreto(): static\n       {\n           return $this->state(fn (array $attributes) => [\n               'secrecy' => 'S',\n           ]);\n       }\n       \n       /** Credencial com nível Reservado */\n       public function reservado(): static\n       {\n           return $this->state(fn (array $attributes) => [\n               'secrecy' => 'R',\n           ]);\n       }\n       \n       /** Credencial válida por longo período */\n       public function longValidity(): static\n       {\n           return $this->state(fn (array $attributes) => [\n               'validity' => now()->addYears(5),\n           ]);\n       }\n   }\n   ```\n\n3. **Adicionar States ao UserFactory**:\n\n   Atualizar `database/factories/UserFactory.php`:\n   ```php\n   <?php\n   namespace Database\\Factories;\n   \n   use App\\Models\\User;\n   use Illuminate\\Database\\Eloquent\\Factories\\Factory;\n   use Illuminate\\Support\\Facades\\Hash;\n   use Illuminate\\Support\\Str;\n   \n   class UserFactory extends Factory\n   {\n       protected static ?string $password = null;\n       \n       public function definition(): array\n       {\n           return [\n               'name' => fake()->name(),\n               'email' => fake()->unique()->safeEmail(),\n               'email_verified_at' => now(),\n               'password' => static::$password ??= Hash::make('password'),\n               'remember_token' => Str::random(10),\n           ];\n       }\n       \n       public function unverified(): static\n       {\n           return $this->state(fn (array $attributes) => [\n               'email_verified_at' => null,\n           ]);\n       }\n       \n       /** Usuário com role admin */\n       public function admin(): static\n       {\n           return $this->afterCreating(function (User $user) {\n               $user->assignRole('admin');\n           });\n       }\n       \n       /** Usuário com role super_admin */\n       public function superAdmin(): static\n       {\n           return $this->afterCreating(function (User $user) {\n               $user->assignRole('super_admin');\n           });\n       }\n       \n       /** Usuário com role consulta (read-only) */\n       public function consulta(): static\n       {\n           return $this->afterCreating(function (User $user) {\n               $user->assignRole('consulta');\n           });\n       }\n       \n       /** Usuário com role operador */\n       public function operador(): static\n       {\n           return $this->afterCreating(function (User $user) {\n               $user->assignRole('operador');\n           });\n       }\n   }\n   ```\n\n4. **Criar ActivityLog Model e Factory**:\n\n   ```bash\n   php artisan make:model ActivityLog\n   php artisan make:factory ActivityLogFactory\n   ```\n\n   `app/Models/ActivityLog.php`:\n   ```php\n   <?php\n   namespace App\\Models;\n   \n   use Illuminate\\Database\\Eloquent\\Model;\n   use Illuminate\\Database\\Eloquent\\Relations\\BelongsTo;\n   \n   /**\n    * @property int $id\n    * @property int|null $user_id\n    * @property int|null $credential_id\n    * @property string $action\n    * @property array|null $old_values\n    * @property array|null $new_values\n    * @property string|null $ip_address\n    * @property string|null $user_agent\n    * @property \\Illuminate\\Support\\Carbon $created_at\n    */\n   class ActivityLog extends Model\n   {\n       public const UPDATED_AT = null;\n       \n       protected $fillable = [\n           'user_id',\n           'credential_id',\n           'action',\n           'old_values',\n           'new_values',\n           'ip_address',\n           'user_agent',\n       ];\n       \n       protected function casts(): array\n       {\n           return [\n               'old_values' => 'array',\n               'new_values' => 'array',\n               'created_at' => 'datetime',\n           ];\n       }\n       \n       /** @return BelongsTo<User, ActivityLog> */\n       public function user(): BelongsTo\n       {\n           return $this->belongsTo(User::class);\n       }\n       \n       /** @return BelongsTo<Credential, ActivityLog> */\n       public function credential(): BelongsTo\n       {\n           return $this->belongsTo(Credential::class);\n       }\n   }\n   ```\n\n   `database/factories/ActivityLogFactory.php`:\n   ```php\n   <?php\n   namespace Database\\Factories;\n   \n   use App\\Models\\ActivityLog;\n   use App\\Models\\User;\n   use App\\Models\\Credential;\n   use Illuminate\\Database\\Eloquent\\Factories\\Factory;\n   \n   class ActivityLogFactory extends Factory\n   {\n       protected $model = ActivityLog::class;\n       \n       public function definition(): array\n       {\n           return [\n               'user_id' => User::factory(),\n               'credential_id' => Credential::factory(),\n               'action' => $this->faker->randomElement(['created', 'updated', 'deleted', 'restored', 'viewed']),\n               'old_values' => null,\n               'new_values' => [\n                   'fscs' => $this->faker->regexify('[A-Z]{3}[0-9]{4}'),\n                   'name' => $this->faker->company(),\n               ],\n               'ip_address' => $this->faker->ipv4(),\n               'user_agent' => $this->faker->userAgent(),\n           ];\n       }\n       \n       public function created(): static\n       {\n           return $this->state(fn (array $attributes) => [\n               'action' => 'created',\n               'old_values' => null,\n           ]);\n       }\n       \n       public function updated(): static\n       {\n           return $this->state(fn (array $attributes) => [\n               'action' => 'updated',\n               'old_values' => [\n                   'fscs' => 'OLD001',\n                   'name' => 'Old Name',\n               ],\n           ]);\n       }\n   }\n   ```\n\n5. **Criar CredentialObserver para Auditoria Automática**:\n\n   ```bash\n   php artisan make:observer CredentialObserver --model=Credential\n   ```\n\n   `app/Observers/CredentialObserver.php`:\n   ```php\n   <?php\n   namespace App\\Observers;\n   \n   use App\\Models\\Credential;\n   use App\\Models\\ActivityLog;\n   use Illuminate\\Support\\Facades\\Auth;\n   \n   class CredentialObserver\n   {\n       public function created(Credential $credential): void\n       {\n           ActivityLog::create([\n               'user_id' => Auth::id(),\n               'credential_id' => $credential->id,\n               'action' => 'created',\n               'old_values' => null,\n               'new_values' => $credential->only(['fscs', 'name', 'secrecy', 'validity']),\n               'ip_address' => request()->ip(),\n               'user_agent' => request()->userAgent(),\n           ]);\n       }\n       \n       public function updated(Credential $credential): void\n       {\n           ActivityLog::create([\n               'user_id' => Auth::id(),\n               'credential_id' => $credential->id,\n               'action' => 'updated',\n               'old_values' => $credential->getOriginal(),\n               'new_values' => $credential->getChanges(),\n               'ip_address' => request()->ip(),\n               'user_agent' => request()->userAgent(),\n           ]);\n       }\n       \n       public function deleted(Credential $credential): void\n       {\n           ActivityLog::create([\n               'user_id' => Auth::id(),\n               'credential_id' => $credential->id,\n               'action' => 'deleted',\n               'old_values' => $credential->only(['fscs', 'name', 'secrecy', 'validity']),\n               'new_values' => null,\n               'ip_address' => request()->ip(),\n               'user_agent' => request()->userAgent(),\n           ]);\n       }\n       \n       public function restored(Credential $credential): void\n       {\n           ActivityLog::create([\n               'user_id' => Auth::id(),\n               'credential_id' => $credential->id,\n               'action' => 'restored',\n               'old_values' => null,\n               'new_values' => $credential->only(['fscs', 'name', 'secrecy', 'validity']),\n               'ip_address' => request()->ip(),\n               'user_agent' => request()->userAgent(),\n           ]);\n       }\n   }\n   ```\n\n   Registrar observer em `app/Providers/AppServiceProvider.php`:\n   ```php\n   use App\\Models\\Credential;\n   use App\\Observers\\CredentialObserver;\n   \n   public function boot(): void\n   {\n       Credential::observe(CredentialObserver::class);\n   }\n   ```\n\n6. **Externalizar Email Hardcoded para Configuração**:\n\n   Adicionar em `config/app.php`:\n   ```php\n   return [\n       // ... outras configs\n       \n       'admin_emails' => explode(',', env('ADMIN_EMAILS', 'admin@admin.com')),\n   ];\n   ```\n\n   Adicionar em `.env`:\n   ```\n   ADMIN_EMAILS=admin@admin.com,superadmin@admin.com\n   ```\n\n   Atualizar `app/Models/User.php`:\n   ```php\n   public function canAccessPanel(Panel $panel): bool\n   {\n       if (in_array($this->email, config('app.admin_emails'))) {\n           return true;\n       }\n       return $this->hasRole(['super_admin', 'admin', 'consulta']);\n   }\n   ```",
        "testStrategy": "1. **Testes de Type Hints e PHPDoc**:\n   ```bash\n   vendor/bin/sail composer require --dev phpstan/phpstan\n   vendor/bin/sail bin phpstan analyse app/Models\n   ```\n   - Verificar que PHPStan não reporta erros de tipagem nos Models\n   - Executar `php artisan tinker` e testar autocompletion das relações\n   - Verificar que IDE reconhece tipos de retorno dos métodos\n\n2. **Testes de Factories com States**:\n   ```php\n   // tests/Unit/FactoriesTest.php\n   test('credential factory cria credencial válida', function () {\n       $credential = Credential::factory()->create();\n       expect($credential->validity)->toBeGreaterThan(now());\n   });\n   \n   test('state expired cria credencial expirada', function () {\n       $credential = Credential::factory()->expired()->create();\n       expect($credential->validity)->toBeLessThan(now());\n   });\n   \n   test('state expiringSoon cria credencial expirando em 30 dias', function () {\n       $credential = Credential::factory()->expiringSoon()->create();\n       expect($credential->validity)->toBeBetween(now(), now()->addDays(30));\n   });\n   \n   test('state secreto define secrecy como S', function () {\n       $credential = Credential::factory()->secreto()->create();\n       expect($credential->secrecy)->toBe('S');\n   });\n   \n   test('state reservado define secrecy como R', function () {\n       $credential = Credential::factory()->reservado()->create();\n       expect($credential->secrecy)->toBe('R');\n   });\n   \n   test('user factory com state admin atribui role correta', function () {\n       $user = User::factory()->admin()->create();\n       expect($user->hasRole('admin'))->toBeTrue();\n   });\n   \n   test('user factory com state superAdmin atribui role correta', function () {\n       $user = User::factory()->superAdmin()->create();\n       expect($user->hasRole('super_admin'))->toBeTrue();\n   });\n   ```\n\n3. **Testes de ActivityLog Model e Observer**:\n   ```php\n   // tests/Feature/ActivityLogTest.php\n   test('observer registra log ao criar credencial', function () {\n       $user = User::factory()->create();\n       $this->actingAs($user);\n       \n       $credential = Credential::factory()->create();\n       \n       expect(ActivityLog::where('credential_id', $credential->id)->count())->toBe(1);\n       $log = ActivityLog::latest()->first();\n       expect($log->action)->toBe('created');\n       expect($log->user_id)->toBe($user->id);\n       expect($log->old_values)->toBeNull();\n       expect($log->new_values)->toHaveKeys(['fscs', 'name', 'secrecy', 'validity']);\n   });\n   \n   test('observer registra old_values ao atualizar credencial', function () {\n       $user = User::factory()->create();\n       $this->actingAs($user);\n       \n       $credential = Credential::factory()->create(['name' => 'Nome Original']);\n       ActivityLog::truncate(); // Limpar log de criação\n       \n       $credential->update(['name' => 'Nome Atualizado']);\n       \n       $log = ActivityLog::latest()->first();\n       expect($log->action)->toBe('updated');\n       expect($log->old_values)->toHaveKey('name', 'Nome Original');\n       expect($log->new_values)->toHaveKey('name', 'Nome Atualizado');\n   });\n   \n   test('observer registra IP e User Agent', function () {\n       $user = User::factory()->create();\n       $this->actingAs($user);\n       \n       $credential = Credential::factory()->create();\n       \n       $log = ActivityLog::latest()->first();\n       expect($log->ip_address)->not->toBeNull();\n       expect($log->user_agent)->not->toBeNull();\n   });\n   ```\n\n4. **Testes de Configuração de Admin Emails**:\n   ```php\n   test('canAccessPanel usa emails da configuração', function () {\n       config(['app.admin_emails' => ['admin@admin.com', 'super@admin.com']]);\n       \n       $user1 = User::factory()->create(['email' => 'admin@admin.com']);\n       $user2 = User::factory()->create(['email' => 'super@admin.com']);\n       $user3 = User::factory()->create(['email' => 'regular@user.com']);\n       \n       expect($user1->canAccessPanel(Filament::getCurrentPanel()))->toBeTrue();\n       expect($user2->canAccessPanel(Filament::getCurrentPanel()))->toBeTrue();\n       expect($user3->canAccessPanel(Filament::getCurrentPanel()))->toBeFalse();\n   });\n   ```\n\n5. **Testes de Método casts()**:\n   ```php\n   test('método casts() retorna configuração correta para User', function () {\n       $user = new User();\n       $casts = $user->getCasts();\n       expect($casts)->toHaveKey('email_verified_at', 'datetime');\n       expect($casts)->toHaveKey('password', 'hashed');\n   });\n   \n   test('método casts() retorna configuração correta para Credential', function () {\n       $credential = new Credential();\n       $casts = $credential->getCasts();\n       expect($casts)->toHaveKey('validity', 'datetime');\n       expect($casts)->toHaveKey('deleted_at', 'datetime');\n   });\n   ```\n\n6. **Executar Suite Completa**:\n   ```bash\n   vendor/bin/sail artisan test --filter=FactoriesTest\n   vendor/bin/sail artisan test --filter=ActivityLogTest\n   vendor/bin/sail artisan test\n   ```",
        "status": "pending",
        "dependencies": [
          11,
          3,
          4
        ],
        "priority": "high",
        "subtasks": []
      },
      {
        "id": 19,
        "title": "FASE 3: Otimização de Database com Índices e Completar Migrations para Rollback",
        "description": "Criar migration add_indexes_to_credentials_table com índices estratégicos (fscs, validity, created_at, composite user_id+validity) e implementar métodos down() faltantes nas migrations 2023_07_25_200512_alter_credentials2_table e 2023_07_25_181600_add_deleted_at_to_credentials para permitir rollback completo do banco de dados.",
        "details": "1. **Criar Migration de Índices para Credentials**:\n   ```bash\n   vendor/bin/sail artisan make:migration add_indexes_to_credentials_table\n   ```\n   ```php\n   <?php\n   use Illuminate\\Database\\Migrations\\Migration;\n   use Illuminate\\Database\\Schema\\Blueprint;\n   use Illuminate\\Support\\Facades\\Schema;\n\n   return new class extends Migration\n   {\n       public function up(): void\n       {\n           Schema::table('credentials', function (Blueprint $table) {\n               // Índice único para FSCS (busca exata, validação de unicidade)\n               $table->unique('fscs', 'credentials_fscs_unique');\n               \n               // Índice para validity (ordenação, filtros de expiração)\n               $table->index('validity', 'credentials_validity_index');\n               \n               // Índice para created_at (ordenação por data de criação)\n               $table->index('created_at', 'credentials_created_at_index');\n               \n               // Índice composto para queries filtradas por user_id e ordenadas por validity\n               $table->index(['user_id', 'validity'], 'credentials_user_validity_index');\n               \n               // Índice para soft deletes (se ainda não existir)\n               if (!Schema::hasColumn('credentials', 'deleted_at')) {\n                   $table->index('deleted_at', 'credentials_deleted_at_index');\n               }\n           });\n       }\n\n       public function down(): void\n       {\n           Schema::table('credentials', function (Blueprint $table) {\n               $table->dropUnique('credentials_fscs_unique');\n               $table->dropIndex('credentials_validity_index');\n               $table->dropIndex('credentials_created_at_index');\n               $table->dropIndex('credentials_user_validity_index');\n               if (Schema::hasColumn('credentials', 'deleted_at')) {\n                   $table->dropIndex('credentials_deleted_at_index');\n               }\n           });\n       }\n   };\n   ```\n\n2. **Implementar down() na Migration 2023_07_25_200512_alter_credentials2_table**:\n   ```php\n   // Localizar arquivo: database/migrations/2023_07_25_200512_alter_credentials2_table.php\n   public function down(): void\n   {\n       Schema::table('credentials', function (Blueprint $table) {\n           // Reverter alterações do up() na ordem inversa\n           // Exemplo (ajustar conforme o que foi feito no up()):\n           if (Schema::hasColumn('credentials', 'user_id')) {\n               $table->dropForeign(['user_id']);\n               $table->dropColumn('user_id');\n           }\n           \n           // Se foram alterados tipos de colunas, reverter:\n           // $table->string('secrecy', 1)->change(); // De volta ao formato antigo\n           \n           // Se foram adicionados índices, remover:\n           // $table->dropIndex('credentials_some_index');\n       });\n   }\n   ```\n\n3. **Implementar down() na Migration 2023_07_25_181600_add_deleted_at_to_credentials**:\n   ```php\n   // Localizar arquivo: database/migrations/2023_07_25_181600_add_deleted_at_to_credentials.php\n   public function down(): void\n   {\n       Schema::table('credentials', function (Blueprint $table) {\n           // Remover soft delete column e índice\n           $table->dropSoftDeletes();\n       });\n   }\n   ```\n\n4. **Análise de Performance e Justificativa dos Índices**:\n   - **fscs (UNIQUE)**: Campo usado em validações de unicidade e buscas exatas frequentes\n   - **validity**: Usado em filtros de status (expirado/válido), ordenações e WHERE clauses\n   - **created_at**: Ordenação padrão em listagens cronológicas\n   - **(user_id, validity) COMPOSITE**: Otimiza query \"credenciais de um usuário ordenadas por validade\"\n   - **deleted_at**: Otimiza queries com withTrashed(), onlyTrashed() do Soft Delete\n\n5. **Verificação de Consistência com Migrations Existentes**:\n   ```bash\n   # Ler migrations existentes para entender alterações anteriores\n   vendor/bin/sail artisan migrate:status\n   cat database/migrations/2023_07_25_200512_alter_credentials2_table.php\n   cat database/migrations/2023_07_25_181600_add_deleted_at_to_credentials.php\n   ```\n\n6. **Executar Migrations e Testar Rollback**:\n   ```bash\n   # Backup antes de aplicar\n   docker-compose exec laravel.test mysqldump -u sail -psail cred_crud > backup_before_indexes.sql\n   \n   # Aplicar nova migration\n   vendor/bin/sail artisan migrate\n   \n   # Testar rollback completo\n   vendor/bin/sail artisan migrate:rollback --step=3\n   \n   # Verificar integridade e re-aplicar\n   vendor/bin/sail artisan migrate\n   ```\n\n7. **Atualizar Model Credential com Índices Documentados**:\n   ```php\n   // app/Models/Credential.php - adicionar PHPDoc\n   /**\n    * Indexes:\n    * - fscs: UNIQUE - validação de unicidade\n    * - validity: INDEX - filtros de expiração\n    * - created_at: INDEX - ordenação cronológica\n    * - (user_id, validity): COMPOSITE INDEX - queries por usuário ordenadas por validade\n    * - deleted_at: INDEX - soft delete queries\n    */\n   class Credential extends Model\n   {\n       use SoftDeletes;\n       // ...\n   }\n   ```",
        "testStrategy": "1. **Teste de Criação de Índices**:\n   ```bash\n   vendor/bin/sail artisan migrate\n   vendor/bin/sail artisan tinker --execute=\"DB::select('SHOW INDEXES FROM credentials');\"\n   ```\n   - Verificar que índices foram criados: credentials_fscs_unique, credentials_validity_index, credentials_created_at_index, credentials_user_validity_index\n   - Confirmar que índice composto aparece com 2 colunas (user_id, validity)\n\n2. **Teste de Rollback Completo**:\n   ```bash\n   # Testar rollback de todas as 3 migrations\n   vendor/bin/sail artisan migrate:rollback --step=3\n   ```\n   - Verificar que índices foram removidos: `SHOW INDEXES FROM credentials`\n   - Confirmar que tabela volta ao estado anterior sem erros\n   - Re-executar migrate e verificar sucesso: `vendor/bin/sail artisan migrate`\n\n3. **Teste de Performance com Índices**:\n   ```bash\n   vendor/bin/sail artisan tinker\n   ```\n   ```php\n   // Criar dataset de teste\n   Credential::factory()->count(5000)->create();\n   \n   // Testar query com EXPLAIN\n   DB::enableQueryLog();\n   \n   // Query 1: Busca por FSCS (deve usar índice unique)\n   Credential::where('fscs', '=', 'TEST-001')->first();\n   \n   // Query 2: Filtro por validade (deve usar índice validity)\n   Credential::where('validity', '>', now())->get();\n   \n   // Query 3: Credenciais de usuário ordenadas por validade (deve usar índice composto)\n   Credential::where('user_id', 1)->orderBy('validity', 'desc')->get();\n   \n   // Query 4: Ordenação por data de criação (deve usar created_at index)\n   Credential::orderBy('created_at', 'desc')->limit(50)->get();\n   \n   dd(DB::getQueryLog());\n   ```\n   - Executar EXPLAIN em cada query e verificar que índices corretos estão sendo usados\n   - Comparar tempo de execução antes/depois dos índices (com dataset de 5k+ registros)\n\n4. **Teste de Integridade com Filament**:\n   ```bash\n   vendor/bin/sail npm run build\n   vendor/bin/sail artisan optimize:clear\n   ```\n   - Acessar painel Filament: http://localhost/admin/credentials\n   - Testar criação de credencial com FSCS duplicado (deve retornar erro de unicidade)\n   - Testar filtros por validade e ordenação no painel\n   - Verificar que queries são rápidas mesmo com 5k+ registros\n\n5. **Teste Unitário de Migrations**:\n   ```php\n   // tests/Feature/Database/MigrationRollbackTest.php\n   test('pode fazer rollback completo das migrations de credentials', function () {\n       Artisan::call('migrate:rollback', ['--step' => 3]);\n       \n       // Verificar que índices foram removidos\n       $indexes = DB::select('SHOW INDEXES FROM credentials');\n       expect($indexes)->not->toContain(fn($idx) => $idx->Key_name === 'credentials_fscs_unique');\n       \n       // Re-migrar\n       Artisan::call('migrate');\n       \n       // Verificar que índices foram recriados\n       $indexes = DB::select('SHOW INDEXES FROM credentials');\n       expect($indexes)->toContain(fn($idx) => $idx->Key_name === 'credentials_fscs_unique');\n   });\n   ```\n\n6. **Validação de Documentação**:\n   - Verificar que Model Credential possui PHPDoc documentando os índices\n   - Atualizar `.taskmaster/docs/database_schema.md` com informações sobre os novos índices\n   - Executar `vendor/bin/sail artisan migrate:status` e confirmar que todas migrations estão aplicadas",
        "status": "pending",
        "dependencies": [
          1,
          4,
          12,
          14
        ],
        "priority": "medium",
        "subtasks": []
      },
      {
        "id": 20,
        "title": "FASE 4: Filament 4 Modernização - Centralizar Lógica de Badges com Enum",
        "description": "Criar app/Enums/BadgeColor.php com enum para centralizar lógica de cores de badges, implementando métodos forRole() e forSecrecy() para eliminar código duplicado entre CredentialsTable e UsersTable, consolidando padrões Filament 4 com TextColumn->badge().",
        "details": "1. **Criar Enum BadgeColor para Centralizar Lógica de Cores**:\n   ```bash\n   mkdir -p app/Enums\n   ```\n   \n   Criar `app/Enums/BadgeColor.php`:\n   ```php\n   <?php\n   namespace App\\Enums;\n\n   enum BadgeColor: string\n   {\n       case SUCCESS = 'success';\n       case WARNING = 'warning';\n       case DANGER = 'danger';\n       case INFO = 'info';\n       case PRIMARY = 'primary';\n       case SECONDARY = 'secondary';\n\n       /**\n        * Retorna a cor apropriada para uma role\n        * \n        * @param string $role\n        * @return self\n        */\n       public static function forRole(string $role): self\n       {\n           return match ($role) {\n               'super_admin' => self::DANGER,\n               'admin' => self::WARNING,\n               'operador' => self::INFO,\n               'consulta' => self::SECONDARY,\n               default => self::PRIMARY,\n           };\n       }\n\n       /**\n        * Retorna a cor apropriada para nível de sigilo\n        * \n        * @param string $secrecy\n        * @return self\n        */\n       public static function forSecrecy(string $secrecy): self\n       {\n           return match ($secrecy) {\n               'S' => self::DANGER,  // Secreto = vermelho\n               'R' => self::WARNING, // Reservado = amarelo\n               default => self::SECONDARY,\n           };\n       }\n\n       /**\n        * Retorna a cor apropriada para status de validade\n        * \n        * @param \\Carbon\\Carbon|null $validityDate\n        * @return self\n        */\n       public static function forValidity(?\\Carbon\\Carbon $validityDate): self\n       {\n           if (!$validityDate) {\n               return self::SECONDARY;\n           }\n\n           $now = now();\n           $daysUntilExpiry = $now->diffInDays($validityDate, false);\n\n           return match (true) {\n               $daysUntilExpiry < 0 => self::DANGER,   // Expirado\n               $daysUntilExpiry <= 30 => self::WARNING, // Expirando em breve\n               default => self::SUCCESS,                // Válido\n           };\n       }\n   }\n   ```\n\n2. **Atualizar CredentialsTable para Usar o Enum**:\n   \n   Editar `app/Filament/Resources/Credentials/Tables/CredentialsTable.php`:\n   ```php\n   <?php\n   namespace App\\Filament\\Resources\\Credentials\\Tables;\n\n   use App\\Enums\\BadgeColor;\n   use Filament\\Tables\\Table;\n   use Filament\\Tables\\Columns\\TextColumn;\n   // ... outros imports\n\n   class CredentialsTable\n   {\n       public static function make(Table $table): Table\n       {\n           return $table\n               ->columns([\n                   TextColumn::make('fscs')\n                       ->label('FSCS')\n                       ->searchable()\n                       ->sortable(),\n                   \n                   TextColumn::make('name')\n                       ->label('Nome')\n                       ->searchable()\n                       ->sortable(),\n                   \n                   TextColumn::make('secrecy')\n                       ->label('Sigilo')\n                       ->badge()\n                       ->color(fn (string $state): string => BadgeColor::forSecrecy($state)->value)\n                       ->formatStateUsing(fn (string $state): string => match ($state) {\n                           'S' => 'Secreto',\n                           'R' => 'Reservado',\n                           default => $state,\n                       }),\n                   \n                   TextColumn::make('validity')\n                       ->label('Validade')\n                       ->date('d/m/Y')\n                       ->badge()\n                       ->color(fn (\\Carbon\\Carbon $state): string => BadgeColor::forValidity($state)->value)\n                       ->sortable(),\n                   \n                   TextColumn::make('user.name')\n                       ->label('Responsável')\n                       ->searchable()\n                       ->sortable()\n                       ->toggleable(),\n                   \n                   TextColumn::make('created_at')\n                       ->label('Criado em')\n                       ->dateTime('d/m/Y H:i')\n                       ->sortable()\n                       ->toggleable(isToggledHiddenByDefault: true),\n               ]);\n       }\n   }\n   ```\n\n3. **Atualizar UsersTable para Usar o Enum**:\n   \n   Editar `app/Filament/Resources/UserResource/Tables/UsersTable.php`:\n   ```php\n   <?php\n   namespace App\\Filament\\Resources\\UserResource\\Tables;\n\n   use App\\Enums\\BadgeColor;\n   use Filament\\Tables\\Table;\n   use Filament\\Tables\\Columns\\TextColumn;\n   // ... outros imports\n\n   class UsersTable\n   {\n       public static function make(Table $table): Table\n       {\n           return $table\n               ->columns([\n                   TextColumn::make('name')\n                       ->label('Nome')\n                       ->searchable()\n                       ->sortable(),\n                   \n                   TextColumn::make('email')\n                       ->label('E-mail')\n                       ->searchable()\n                       ->sortable(),\n                   \n                   TextColumn::make('roles.name')\n                       ->label('Papel')\n                       ->badge()\n                       ->color(fn (string $state): string => BadgeColor::forRole($state)->value)\n                       ->formatStateUsing(fn (string $state): string => match ($state) {\n                           'super_admin' => 'Super Admin',\n                           'admin' => 'Admin',\n                           'operador' => 'Operador',\n                           'consulta' => 'Consulta',\n                           default => ucfirst($state),\n                       }),\n                   \n                   TextColumn::make('credentials_count')\n                       ->label('Credenciais')\n                       ->counts('credentials')\n                       ->sortable(),\n                   \n                   TextColumn::make('created_at')\n                       ->label('Criado em')\n                       ->dateTime('d/m/Y H:i')\n                       ->sortable()\n                       ->toggleable(isToggledHiddenByDefault: true),\n               ]);\n       }\n   }\n   ```\n\n4. **Remover Código Duplicado de Lógica de Cores**:\n   - Verificar `app/Filament/Resources/Credentials/CredentialResource.php` e remover closures inline de cores\n   - Verificar `app/Filament/Resources/UserResource.php` e remover closures inline de cores\n   - Garantir que todas as referências a `BadgeColumn` foram substituídas por `TextColumn->badge()`\n\n5. **Validar Namespaces Filament 4**:\n   ```bash\n   # Verificar que não há imports incorretos\n   vendor/bin/sail bin grep -r \"use Filament\\\\Tables\\\\Actions\\\\EditAction\" app/Filament/\n   vendor/bin/sail bin grep -r \"use Filament\\\\Forms\\\\Form\" app/Filament/\n   vendor/bin/sail bin grep -r \"BadgeColumn\" app/Filament/\n   ```\n   - Todos devem retornar vazio (nenhum resultado)\n\n6. **Documentar Padrão no CLAUDE.md**:\n   - Adicionar seção sobre uso de Enums para lógica de negócio\n   - Documentar padrão de cores de badges centralizado\n   - Incluir exemplos de uso do BadgeColor enum",
        "testStrategy": "1. **Testes de Criação do Enum**:\n   ```bash\n   vendor/bin/sail artisan tinker --execute=\"echo class_exists('\\\\App\\\\Enums\\\\BadgeColor') ? 'OK' : 'ERRO';\"\n   ```\n   - Verificar que enum foi criado corretamente\n   - Testar métodos estáticos:\n   ```php\n   use App\\Enums\\BadgeColor;\n   echo BadgeColor::forRole('super_admin')->value; // deve retornar 'danger'\n   echo BadgeColor::forRole('admin')->value; // deve retornar 'warning'\n   echo BadgeColor::forSecrecy('S')->value; // deve retornar 'danger'\n   echo BadgeColor::forSecrecy('R')->value; // deve retornar 'warning'\n   ```\n\n2. **Testes de Integração com Filament**:\n   ```bash\n   vendor/bin/sail up -d\n   vendor/bin/sail npm run build\n   ```\n   - Acessar http://localhost/admin/credentials\n   - Verificar que badges de 'Sigilo' aparecem com cores corretas (Secreto=vermelho, Reservado=amarelo)\n   - Verificar que badges de 'Validade' aparecem com cores corretas (expirado=vermelho, expirando=amarelo, válido=verde)\n   - Acessar http://localhost/admin/users\n   - Verificar que badges de 'Papel' aparecem com cores corretas (super_admin=vermelho, admin=amarelo, consulta=cinza)\n\n3. **Testes de Ausência de Código Duplicado**:\n   ```bash\n   vendor/bin/sail bin grep -rn \"match.*role\" app/Filament/Resources/\n   vendor/bin/sail bin grep -rn \"match.*secrecy\" app/Filament/Resources/\n   ```\n   - Verificar que lógica de match() aparece APENAS no enum, não nos Resources\n\n4. **Testes de Namespace Correto Filament 4**:\n   ```bash\n   vendor/bin/sail bin grep -r \"BadgeColumn\" app/Filament/\n   vendor/bin/sail bin grep -r \"Filament\\\\\\\\Tables\\\\\\\\Actions\\\\\\\\EditAction\" app/Filament/\n   vendor/bin/sail bin grep -r \"Filament\\\\\\\\Forms\\\\\\\\Form\" app/\n   ```\n   - Todos devem retornar vazio (nenhuma ocorrência)\n   - Confirmar uso correto: `Filament\\Actions\\EditAction`, `Filament\\Schemas\\Schema`\n\n5. **Teste de Formatação com Pint**:\n   ```bash\n   vendor/bin/sail bin pint app/Enums/BadgeColor.php\n   vendor/bin/sail bin pint app/Filament/Resources/Credentials/Tables/CredentialsTable.php\n   vendor/bin/sail bin pint app/Filament/Resources/UserResource/Tables/UsersTable.php\n   ```\n   - Confirmar que código está formatado segundo Laravel Pint\n\n6. **Testes Funcionais de Renderização**:\n   - Criar credencial com secrecy='S' e verificar badge vermelho\n   - Criar credencial com secrecy='R' e verificar badge amarelo\n   - Criar credencial com validity no passado e verificar badge vermelho\n   - Criar credencial com validity daqui 15 dias e verificar badge amarelo\n   - Criar credencial com validity daqui 60 dias e verificar badge verde\n   - Verificar usuário com role 'super_admin' mostra badge vermelho\n   - Verificar usuário com role 'consulta' mostra badge cinza",
        "status": "pending",
        "dependencies": [
          17,
          16
        ],
        "priority": "low",
        "subtasks": []
      },
      {
        "id": 21,
        "title": "FASE 5: Suite Completa de Testes com Pest - Refatoração e Cobertura Filament",
        "description": "Refatorar testes existentes para usar factories, remover testes obsoletos de rotas inexistentes, criar suite completa de testes Livewire para recursos Filament (Credentials e Users), implementar testes unitários de Policies e testes de integração para ActivityLog Observer, relacionamentos e soft deletes.",
        "details": "1. **Refatorar RoleAuthorizationTest para Usar Factories**:\n   Editar `tests/Feature/RoleAuthorizationTest.php`:\n   ```php\n   use App\\Models\\User;\n   use Database\\Factories\\UserFactory;\n   \n   it('super_admin pode acessar painel', function () {\n       $user = User::factory()->create();\n       $user->assignRole('super_admin');\n       \n       $this->actingAs($user)\n           ->get('/admin')\n           ->assertStatus(200);\n   });\n   \n   it('consulta pode visualizar mas não editar credenciais', function () {\n       $user = User::factory()->create();\n       $user->assignRole('consulta');\n       \n       $this->actingAs($user)\n           ->get(route('filament.admin.resources.credentials.index'))\n           ->assertSuccessful();\n   });\n   ```\n\n2. **Deletar Teste Obsoleto**:\n   ```bash\n   vendor/bin/sail bash -c \"rm tests/Feature/CredentialValidationTest.php\"\n   ```\n\n3. **Criar Testes Filament para CredentialResource**:\n   ```bash\n   vendor/bin/sail artisan make:test Feature/Filament/CredentialResourceTest --pest\n   ```\n   \n   Implementar `tests/Feature/Filament/CredentialResourceTest.php`:\n   ```php\n   <?php\n   use App\\Models\\User;\n   use App\\Models\\Credential;\n   use Filament\\Actions\\DeleteAction;\n   use function Pest\\Livewire\\livewire;\n   \n   beforeEach(function () {\n       $this->admin = User::factory()->create();\n       $this->admin->assignRole('super_admin');\n       $this->actingAs($this->admin);\n   });\n   \n   it('pode listar credenciais', function () {\n       $credentials = Credential::factory()->count(5)->create();\n       \n       livewire(\\App\\Filament\\Resources\\Credentials\\Pages\\ListCredentials::class)\n           ->assertCanSeeTableRecords($credentials)\n           ->assertCountTableRecords(5);\n   });\n   \n   it('pode criar credencial com validação de FSCS único', function () {\n       livewire(\\App\\Filament\\Resources\\Credentials\\Pages\\CreateCredential::class)\n           ->fillForm([\n               'fscs' => 'TEST-001',\n               'name' => 'Credencial Teste',\n               'secrecy' => 'R',\n               'validity' => now()->addYear()->format('Y-m-d'),\n           ])\n           ->call('create')\n           ->assertHasNoFormErrors();\n       \n       $this->assertDatabaseHas('credentials', ['fscs' => 'TEST-001']);\n   });\n   \n   it('valida FSCS duplicado', function () {\n       $existing = Credential::factory()->create(['fscs' => 'DUP-001']);\n       \n       livewire(\\App\\Filament\\Resources\\Credentials\\Pages\\CreateCredential::class)\n           ->fillForm([\n               'fscs' => 'DUP-001',\n               'name' => 'Duplicada',\n               'secrecy' => 'S',\n               'validity' => now()->addYear()->format('Y-m-d'),\n           ])\n           ->call('create')\n           ->assertHasFormErrors(['fscs' => 'unique']);\n   });\n   \n   it('pode editar credencial', function () {\n       $credential = Credential::factory()->create();\n       \n       livewire(\\App\\Filament\\Resources\\Credentials\\Pages\\EditCredential::class, [\n           'record' => $credential->getRouteKey(),\n       ])\n           ->fillForm(['name' => 'Nome Atualizado'])\n           ->call('save')\n           ->assertHasNoFormErrors();\n       \n       expect($credential->fresh()->name)->toBe('Nome Atualizado');\n   });\n   \n   it('pode deletar credencial (soft delete)', function () {\n       $credential = Credential::factory()->create();\n       \n       livewire(\\App\\Filament\\Resources\\Credentials\\Pages\\EditCredential::class, [\n           'record' => $credential->getRouteKey(),\n       ])\n           ->callAction(DeleteAction::class);\n       \n       $this->assertSoftDeleted('credentials', ['id' => $credential->id]);\n   });\n   \n   it('pode filtrar por secrecy level', function () {\n       Credential::factory()->count(3)->create(['secrecy' => 'R']);\n       Credential::factory()->count(2)->create(['secrecy' => 'S']);\n       \n       livewire(\\App\\Filament\\Resources\\Credentials\\Pages\\ListCredentials::class)\n           ->filterTable('secrecy', 'R')\n           ->assertCountTableRecords(3);\n   });\n   \n   it('pode filtrar por status de validade', function () {\n       Credential::factory()->count(2)->create(['validity' => now()->subDays(10)]); // Expiradas\n       Credential::factory()->count(3)->create(['validity' => now()->addDays(15)]); // Expirando\n       Credential::factory()->count(5)->create(['validity' => now()->addYear()]); // Válidas\n       \n       livewire(\\App\\Filament\\Resources\\Credentials\\Pages\\ListCredentials::class)\n           ->filterTable('validity_status', 'expired')\n           ->assertCountTableRecords(2);\n   });\n   \n   it('pode executar bulk delete', function () {\n       $credentials = Credential::factory()->count(5)->create();\n       \n       livewire(\\App\\Filament\\Resources\\Credentials\\Pages\\ListCredentials::class)\n           ->selectTableRecords($credentials->pluck('id')->toArray())\n           ->callTableBulkAction('delete');\n       \n       foreach ($credentials as $credential) {\n           $this->assertSoftDeleted('credentials', ['id' => $credential->id]);\n       }\n   });\n   ```\n\n4. **Criar Testes Filament para UserResource**:\n   ```bash\n   vendor/bin/sail artisan make:test Feature/Filament/UserResourceTest --pest\n   ```\n   \n   Implementar `tests/Feature/Filament/UserResourceTest.php`:\n   ```php\n   <?php\n   use App\\Models\\User;\n   use Filament\\Actions\\DeleteAction;\n   use function Pest\\Livewire\\livewire;\n   \n   beforeEach(function () {\n       $this->admin = User::factory()->create();\n       $this->admin->assignRole('super_admin');\n       $this->actingAs($this->admin);\n   });\n   \n   it('pode listar usuários', function () {\n       $users = User::factory()->count(5)->create();\n       \n       livewire(\\App\\Filament\\Resources\\UserResource\\Pages\\ListUsers::class)\n           ->assertCanSeeTableRecords($users);\n   });\n   \n   it('pode criar usuário com role', function () {\n       livewire(\\App\\Filament\\Resources\\UserResource\\Pages\\CreateUser::class)\n           ->fillForm([\n               'name' => 'Novo Usuário',\n               'email' => 'novo@example.com',\n               'password' => 'password123',\n               'password_confirmation' => 'password123',\n               'roles' => ['admin'],\n           ])\n           ->call('create')\n           ->assertHasNoFormErrors();\n       \n       $user = User::where('email', 'novo@example.com')->first();\n       expect($user)->not->toBeNull()\n           ->and($user->hasRole('admin'))->toBeTrue();\n   });\n   \n   it('valida email único ao criar usuário', function () {\n       $existing = User::factory()->create(['email' => 'existing@example.com']);\n       \n       livewire(\\App\\Filament\\Resources\\UserResource\\Pages\\CreateUser::class)\n           ->fillForm([\n               'name' => 'Duplicado',\n               'email' => 'existing@example.com',\n               'password' => 'password123',\n           ])\n           ->call('create')\n           ->assertHasFormErrors(['email' => 'unique']);\n   });\n   \n   it('pode editar usuário e alterar roles', function () {\n       $user = User::factory()->create();\n       $user->assignRole('consulta');\n       \n       livewire(\\App\\Filament\\Resources\\UserResource\\Pages\\EditUser::class, [\n           'record' => $user->getRouteKey(),\n       ])\n           ->fillForm(['roles' => ['admin']])\n           ->call('save')\n           ->assertHasNoFormErrors();\n       \n       expect($user->fresh()->hasRole('admin'))->toBeTrue()\n           ->and($user->fresh()->hasRole('consulta'))->toBeFalse();\n   });\n   \n   it('exibe badge de role com cor correta', function () {\n       $admin = User::factory()->create();\n       $admin->assignRole('super_admin');\n       \n       livewire(\\App\\Filament\\Resources\\UserResource\\Pages\\ListUsers::class)\n           ->assertTableColumnStateSet('roles', 'success', $admin);\n   });\n   \n   it('pode filtrar por role', function () {\n       $admins = User::factory()->count(3)->create()->each(fn($u) => $u->assignRole('admin'));\n       $consultants = User::factory()->count(2)->create()->each(fn($u) => $u->assignRole('consulta'));\n       \n       livewire(\\App\\Filament\\Resources\\UserResource\\Pages\\ListUsers::class)\n           ->filterTable('roles', 'admin')\n           ->assertCountTableRecords(3);\n   });\n   ```\n\n5. **Criar Testes Unitários de Policies**:\n   ```bash\n   vendor/bin/sail artisan make:test Unit/PolicyTest --pest --unit\n   ```\n   \n   Implementar `tests/Unit/PolicyTest.php`:\n   ```php\n   <?php\n   use App\\Models\\User;\n   use App\\Models\\Credential;\n   use App\\Policies\\CredentialPolicy;\n   use App\\Policies\\UserPolicy;\n   \n   describe('CredentialPolicy', function () {\n       it('permite super_admin visualizar qualquer credencial', function () {\n           $admin = User::factory()->create();\n           $admin->assignRole('super_admin');\n           $credential = Credential::factory()->create();\n           \n           $policy = new CredentialPolicy();\n           expect($policy->view($admin, $credential))->toBeTrue();\n       });\n       \n       it('permite admin criar credenciais', function () {\n           $admin = User::factory()->create();\n           $admin->assignRole('admin');\n           \n           $policy = new CredentialPolicy();\n           expect($policy->create($admin))->toBeTrue();\n       });\n       \n       it('bloqueia consulta de criar credenciais', function () {\n           $consultant = User::factory()->create();\n           $consultant->assignRole('consulta');\n           \n           $policy = new CredentialPolicy();\n           expect($policy->create($consultant))->toBeFalse();\n       });\n       \n       it('permite admin deletar credenciais', function () {\n           $admin = User::factory()->create();\n           $admin->assignRole('admin');\n           $credential = Credential::factory()->create();\n           \n           $policy = new CredentialPolicy();\n           expect($policy->delete($admin, $credential))->toBeTrue();\n       });\n       \n       it('bloqueia consulta de deletar credenciais', function () {\n           $consultant = User::factory()->create();\n           $consultant->assignRole('consulta');\n           $credential = Credential::factory()->create();\n           \n           $policy = new CredentialPolicy();\n           expect($policy->delete($consultant, $credential))->toBeFalse();\n       });\n   });\n   \n   describe('UserPolicy', function () {\n       it('permite super_admin gerenciar usuários', function () {\n           $superAdmin = User::factory()->create();\n           $superAdmin->assignRole('super_admin');\n           $targetUser = User::factory()->create();\n           \n           $policy = new UserPolicy();\n           expect($policy->viewAny($superAdmin))->toBeTrue()\n               ->and($policy->create($superAdmin))->toBeTrue()\n               ->and($policy->update($superAdmin, $targetUser))->toBeTrue()\n               ->and($policy->delete($superAdmin, $targetUser))->toBeTrue();\n       });\n       \n       it('bloqueia consulta de gerenciar usuários', function () {\n           $consultant = User::factory()->create();\n           $consultant->assignRole('consulta');\n           $targetUser = User::factory()->create();\n           \n           $policy = new UserPolicy();\n           expect($policy->create($consultant))->toBeFalse()\n               ->and($policy->update($consultant, $targetUser))->toBeFalse()\n               ->and($policy->delete($consultant, $targetUser))->toBeFalse();\n       });\n   });\n   ```\n\n6. **Criar Testes de Integração para ActivityLog Observer**:\n   ```bash\n   vendor/bin/sail artisan make:test Feature/ActivityLogObserverTest --pest\n   ```\n   \n   Implementar `tests/Feature/ActivityLogObserverTest.php`:\n   ```php\n   <?php\n   use App\\Models\\User;\n   use App\\Models\\Credential;\n   use Illuminate\\Support\\Facades\\DB;\n   \n   beforeEach(function () {\n       $this->user = User::factory()->create();\n       $this->actingAs($this->user);\n   });\n   \n   it('registra criação de credencial no activity log', function () {\n       $credential = Credential::factory()->create([\n           'fscs' => 'LOG-001',\n           'name' => 'Credencial Auditada',\n       ]);\n       \n       $this->assertDatabaseHas('activity_logs', [\n           'model_type' => Credential::class,\n           'model_id' => $credential->id,\n           'action' => 'created',\n           'user_id' => $this->user->id,\n       ]);\n   });\n   \n   it('registra atualização de credencial no activity log', function () {\n       $credential = Credential::factory()->create();\n       \n       $credential->update(['name' => 'Nome Atualizado']);\n       \n       $this->assertDatabaseHas('activity_logs', [\n           'model_type' => Credential::class,\n           'model_id' => $credential->id,\n           'action' => 'updated',\n       ]);\n       \n       $log = DB::table('activity_logs')\n           ->where('model_id', $credential->id)\n           ->where('action', 'updated')\n           ->first();\n       \n       $changes = json_decode($log->changes, true);\n       expect($changes['name'])->toBe('Nome Atualizado');\n   });\n   \n   it('registra deleção (soft delete) no activity log', function () {\n       $credential = Credential::factory()->create();\n       $credentialId = $credential->id;\n       \n       $credential->delete();\n       \n       $this->assertDatabaseHas('activity_logs', [\n           'model_type' => Credential::class,\n           'model_id' => $credentialId,\n           'action' => 'deleted',\n       ]);\n   });\n   ```\n\n7. **Criar Testes de Relacionamentos e Soft Deletes**:\n   ```bash\n   vendor/bin/sail artisan make:test Feature/RelationshipsTest --pest\n   ```\n   \n   Implementar `tests/Feature/RelationshipsTest.php`:\n   ```php\n   <?php\n   use App\\Models\\User;\n   use App\\Models\\Credential;\n   \n   it('user hasMany credentials', function () {\n       $user = User::factory()->create();\n       $credentials = Credential::factory()->count(3)->create(['user_id' => $user->id]);\n       \n       expect($user->credentials)->toHaveCount(3)\n           ->and($user->credentials->first())->toBeInstanceOf(Credential::class);\n   });\n   \n   it('credential belongsTo user', function () {\n       $user = User::factory()->create();\n       $credential = Credential::factory()->create(['user_id' => $user->id]);\n       \n       expect($credential->user)->toBeInstanceOf(User::class)\n           ->and($credential->user->id)->toBe($user->id);\n   });\n   \n   it('soft delete de user seta NULL em credentials (SET NULL)', function () {\n       $user = User::factory()->create();\n       $credential = Credential::factory()->create(['user_id' => $user->id]);\n       \n       $user->delete();\n       \n       expect($credential->fresh()->user_id)->toBeNull()\n           ->and($credential->fresh()->trashed())->toBeFalse(); // Credencial não foi deletada\n   });\n   \n   it('soft delete preserva credencial no banco', function () {\n       $credential = Credential::factory()->create(['fscs' => 'SOFT-001']);\n       $credentialId = $credential->id;\n       \n       $credential->delete();\n       \n       $this->assertSoftDeleted('credentials', ['id' => $credentialId]);\n       \n       // Verifica que não aparece em queries normais\n       expect(Credential::find($credentialId))->toBeNull()\n           ->and(Credential::withTrashed()->find($credentialId))->not->toBeNull();\n   });\n   \n   it('pode restaurar credencial soft deleted', function () {\n       $credential = Credential::factory()->create();\n       $credential->delete();\n       \n       $credential->restore();\n       \n       expect($credential->trashed())->toBeFalse()\n           ->and(Credential::find($credential->id))->not->toBeNull();\n   });\n   \n   it('força deleção permanente com forceDelete', function () {\n       $credential = Credential::factory()->create(['fscs' => 'FORCE-DEL']);\n       $credentialId = $credential->id;\n       \n       $credential->forceDelete();\n       \n       $this->assertDatabaseMissing('credentials', ['id' => $credentialId]);\n       expect(Credential::withTrashed()->find($credentialId))->toBeNull();\n   });\n   ```\n\n8. **Executar Formatação e Testes**:\n   ```bash\n   vendor/bin/sail bin pint --dirty\n   vendor/bin/sail artisan test\n   ```",
        "testStrategy": "1. **Validar Refatoração de RoleAuthorizationTest**:\n   ```bash\n   vendor/bin/sail artisan test tests/Feature/RoleAuthorizationTest.php\n   ```\n   - Confirmar que todos os testes passam usando factories\n   - Verificar que não há mais User::create() manual no arquivo\n\n2. **Confirmar Remoção de Teste Obsoleto**:\n   ```bash\n   ls tests/Feature/CredentialValidationTest.php\n   ```\n   - Deve retornar erro \"No such file or directory\"\n\n3. **Executar Suite Completa de Testes Filament**:\n   ```bash\n   vendor/bin/sail artisan test tests/Feature/Filament/CredentialResourceTest.php --coverage\n   vendor/bin/sail artisan test tests/Feature/Filament/UserResourceTest.php --coverage\n   ```\n   - Todos os testes devem passar (verde)\n   - Cobertura mínima de 90% nos Resources\n\n4. **Executar Testes Unitários de Policies**:\n   ```bash\n   vendor/bin/sail artisan test tests/Unit/PolicyTest.php\n   ```\n   - Confirmar que todas as asserções de permissões passam\n   - Verificar que super_admin tem acesso total\n   - Verificar que consulta tem acesso limitado\n\n5. **Executar Testes de Integração**:\n   ```bash\n   vendor/bin/sail artisan test tests/Feature/ActivityLogObserverTest.php\n   vendor/bin/sail artisan test tests/Feature/RelationshipsTest.php\n   ```\n   - Confirmar que activity_logs são criados corretamente\n   - Verificar soft deletes funcionam conforme esperado\n   - Confirmar que relacionamentos funcionam bidirecionalmente\n\n6. **Executar Suite Completa com Cobertura**:\n   ```bash\n   vendor/bin/sail artisan test --coverage --min=80\n   ```\n   - Cobertura deve ser >= 80% no total\n   - Verificar que não há testes falhando\n\n7. **Teste Manual no Painel Filament**:\n   - Acessar http://localhost/admin/credentials\n   - Criar credencial e verificar no log: `vendor/bin/sail artisan tinker --execute=\"DB::table('activity_logs')->latest()->first();\"`\n   - Deletar credencial e confirmar soft delete\n   - Acessar http://localhost/admin/users\n   - Filtrar por role e verificar resultados\n\n8. **Validação Final**:\n   ```bash\n   vendor/bin/sail artisan test --parallel\n   vendor/bin/sail bin pint --test\n   ```\n   - Testes devem passar em execução paralela\n   - Código deve estar formatado (Pint)\n   - Nenhum erro de tipagem (PHPStan se instalado)",
        "status": "pending",
        "dependencies": [
          10,
          11,
          17,
          18
        ],
        "priority": "high",
        "subtasks": []
      }
    ],
    "metadata": {
      "version": "1.0.0",
      "lastModified": "2025-11-20T06:14:15.893Z",
      "taskCount": 16,
      "completedCount": 4,
      "tags": [
        "master"
      ],
      "created": "2025-11-20T21:44:20.847Z",
      "description": "Tasks for master context",
      "updated": "2025-11-20T21:49:37.565Z"
    }
  }
}